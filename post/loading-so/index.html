<!doctype html>
<html
  lang="zh-cn" 
  data-theme-mode="auto"
  >
  <head><meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/><title>
  Android so加载源码分析与加壳技术 | Asu1tty
</title>
<meta
  name="description"
  content="逆向小白学习中..."
/><script>
  window.siteConfig = JSON.parse("{\"anchor_icon\":null,\"base\":\"https://asu1tty.github.io/\",\"clipboard\":{\"copyright\":{\"count\":50,\"enable\":false,\"license_type\":\"by-nc-sa\"},\"fail\":{\"en\":\"Copy failed (ﾟ⊿ﾟ)ﾂ\",\"ja\":\"コピー失敗 (ﾟ⊿ﾟ)ﾂ\",\"zh-cn\":\"复制失败 (ﾟ⊿ﾟ)ﾂ\",\"zh-tw\":\"複製失敗 (ﾟ⊿ﾟ)ﾂ\"},\"success\":{\"en\":\"Copy successfully (*^▽^*)\",\"ja\":\"コピー成功 (*^▽^*)\",\"zh-cn\":\"复制成功 (*^▽^*)\",\"zh-tw\":\"複製成功 (*^▽^*)\"}},\"code_block\":{\"expand\":40},\"i18n_languages\":[{\"Lang\":\"en\",\"LanguageName\":\"English\",\"LanguageCode\":\"\",\"Title\":\"\",\"LanguageDirection\":\"\",\"Weight\":1,\"Disabled\":false},{\"Lang\":\"ja\",\"LanguageName\":\"日本語\",\"LanguageCode\":\"\",\"Title\":\"\",\"LanguageDirection\":\"\",\"Weight\":1,\"Disabled\":false},{\"Lang\":\"zh-cn\",\"LanguageName\":\"简体中文\",\"LanguageCode\":\"\",\"Title\":\"\",\"LanguageDirection\":\"\",\"Weight\":1,\"Disabled\":false},{\"Lang\":\"zh-tw\",\"LanguageName\":\"繁體中文\",\"LanguageCode\":\"\",\"Title\":\"\",\"LanguageDirection\":\"\",\"Weight\":1,\"Disabled\":false}],\"icon_font\":\"4552607_0khxww3tj3q9\",\"outdate\":{\"daysago\":180,\"enable\":false,\"message\":{\"en\":\"This article was last updated on {time}. Please note that the content may no longer be applicable.\",\"ja\":\"この記事は最終更新日：{time}。記載内容が現在有効でない可能性がありますのでご注意ください。\",\"zh-cn\":\"本文最后更新于 {time}，请注意文中内容可能已不适用。\",\"zh-tw\":\"本文最後更新於 {time}，請注意文中內容可能已不適用。\"}}}");
  
</script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
/>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
  media="print"
  onload="this.media='all'"
/>
<link
    rel="preload"
    href="//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2"
    as="font"
    type="font/woff2"
    crossorigin="anonymous"
  /><link rel="stylesheet" href="/css/loader.min.ac746e154f756f8220326eeb52a719f142ab038be5a8ddf30ea5ef15ef2356ea.css" />
<meta property="og:type" content="website" />
  <meta property="og:title" content="Android so加载源码分析与加壳技术 | Asu1tty" />
  <meta
    property="og:description"
    content="逆向小白学习中..."
  />
  <meta property="og:url" content="https://asu1tty.github.io/post/loading-so/" />
  <meta
    property="og:site_name"
    content="Asu1tty&#39;s Blog"
  />
  <meta
    property="og:image"
    content="/"
  />
  <meta property="article:author" content="Asu1tty" />
  <meta property="article:published_time" content="2025-05-01T11:20:50&#43;08:00" />
  <meta property="article:modified_time" content="2025-05-01T11:20:50&#43;08:00" /><meta property="article:tag" content="Android" /><meta name="twitter:card" content="summary" />
  <meta name="twitter:image" content="/" />
<link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/main.min.6b3f96d0d04f98678149e3cf7e64b2c567b840637aada3b4698b20028152a942.css" />
<link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css"
    integrity="sha384-IfxC36XL/toUyJ939C73PcgMuRzAZuIzZxE38drsmO5p6jD7ei&#43;Zx/1oA/0l8ysE" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/katex@0.16.22/dist/katex.min.css"
    integrity="sha384-5TcZemv2l/9On385z///&#43;d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><script
    src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js"
    integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script><link
    rel="stylesheet"
    href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css"
    integrity="sha384-4NN3fZ5AokFyHuoihl7A9qWaCt&#43;HsAtOaUsXwJGRb4/SMBtFr2vcNSHR5E8dg0Wk" crossorigin="anonymous"/></head>
  <body><div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi rotate"><svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="var(--red-1, #ff5252)" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
          M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="var(--red-1, #ff5252)" />
          </svg></div><div class="loading-word">加载中...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script><div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>
<div id="lang-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
本文章没有找到对应的语言版本
</div>
<div id="heatmap-tooltip"></div><div id="container">
      <div id="wrap"><div id="header-nav">
  <nav id="main-nav"><span class="main-nav-link-wrap">
        <div class='main-nav-icon icon rotate'>&#xe62b;</div>
        <a class="main-nav-link" href="/">首页</a>
      </span><span class="main-nav-link-wrap">
        <div class='main-nav-icon icon rotate'>&#xe62b;</div>
        <a class="main-nav-link" href="/archives">归档</a>
      </span><span class="main-nav-link-wrap">
        <div class='main-nav-icon icon rotate'>&#xe62b;</div>
        <a class="main-nav-link" href="/about">关于</a>
      </span><span class="main-nav-link-wrap">
        <div class='main-nav-icon icon rotate'>&#xe62b;</div>
        <a class="main-nav-link" href="/friend">友链</a>
      </span><a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav"></nav><nav id="i18n-nav">
      <div class="custom-dropdown">
        <div class="select-selected" id="select-selected">
          <span id="nav-language-btn" class="nav-icon" style="padding: 0 20px 0 0"></span>
          <span id="selected-lang">简体中文</span>
        </div>
        <ul class="select-items" id="select-items"><li data-value="en"  >English</li><li data-value="ja"  >日本語</li><li data-value="zh-cn" class="selected" >简体中文</li><li data-value="zh-tw"  >繁體中文</li></ul>
      </div>
      <script>
        var selectSelected = document.getElementById("select-selected");
        var selectedLang = document.getElementById("selected-lang");
        var selectItems = document.getElementById("select-items");
        var selectOptions = selectItems.querySelectorAll("li");

        selectSelected.addEventListener("click", () => {
          selectItems.classList.toggle("show");
        });

        selectOptions.forEach((item) => {
          item.addEventListener("click", () => {
            const langMap = {};selectedLang.textContent = item.textContent;
            selectItems.classList.remove("show");
            selectOptions.forEach((option) => {
              option.classList.remove("selected");
            });
            item.classList.add("selected");
            if (item.dataset.value === 'zh-cn') {
              return;
            }
            if (!langMap[item.dataset.value]) {
              _$("#lang-tooltip").style.opacity = "1";
              setTimeout(() => {
                _$("#lang-tooltip").style.opacity = "0";
              }, 1000);
              return;
            }
            window.location = langMap[item.dataset.value];
          });
        });

        document.addEventListener("click", (event) => {
          if (!event.target.closest(".custom-dropdown")) {
            selectItems.classList.remove("show");
          }
        });
      </script>
    </nav></div>
<header id="header"><picture></picture><img  fetchpriority="high" src="/images/banner.webp" alt="Android so加载源码分析与加壳技术"><div id="header-outer">
    <div id="header-title"><a href="/" id="logo">
            <h1 data-aos="slide-up">Android so加载源码分析与加壳技术</h1>
          </a><h2 id="subtitle-wrap" data-aos="slide-down"></h2></div>
  </div>
</header><div id="content"
          
          class="sidebar-right"  ><aside id="sidebar"><div class="sidebar-wrapper wrap-sticky">
    <div
      class="sidebar-wrap"
      data-aos="fade-up"
    ><div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">文章目录</h3>
  <div class="sidebar-toc-wrapper toc-div-class">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-java层调用">1. java层调用</a>
      <ul>
        <li><a href="#11-systemload">1.1. System.load()</a></li>
        <li><a href="#12-runtimegetruntimeload0">1.2. Runtime.getRuntime().load0()</a></li>
        <li><a href="#13-runtimejava-中的-nativeload">1.3. Runtime.java 中的 nativeLoad()</a></li>
      </ul>
    </li>
    <li><a href="#2-so层调用">2. so层调用</a>
      <ul>
        <li><a href="#21-runtimec-中的-nativeload">2.1. Runtime.c 中的 nativeLoad()</a></li>
        <li><a href="#22-jvm_nativeload">2.2. JVM_NativeLoad()</a></li>
        <li><a href="#23-loadnativelibrary">2.3. LoadNativeLibrary()</a></li>
        <li><a href="#24-androidopennativelibrary">2.4. android::OpenNativeLibrary()</a></li>
        <li><a href="#25-android_dlopen_ext">2.5. android_dlopen_ext()</a></li>
        <li><a href="#26-__loader_android_dlopen_ext">2.6. __loader_android_dlopen_ext()</a></li>
        <li><a href="#27-dlopen_ext">2.7. dlopen_ext</a></li>
        <li><a href="#28-do_dlopen">2.8. do_dlopen</a></li>
        <li><a href="#29-find_library">2.9. find_library</a></li>
        <li><a href="#210-find_libraries">2.10. find_libraries</a></li>
      </ul>
    </li>
    <li><a href="#3-加壳技术">3. 加壳技术</a>
      <ul>
        <li><a href="#31-loader-执行时机">3.1. loader 执行时机</a></li>
        <li><a href="#32-loader-完成-so-的加载链接">3.2. loader 完成 SO 的加载链接</a></li>
        <li><a href="#33-soinfo-修复">3.3. soinfo 修复</a></li>
      </ul>
    </li>
    <li><a href="#4-参考资料">4. 参考资料</a></li>
  </ul>
</nav>
  </div>
</div></div>
          <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img
    data-src="/avatar/avatar.webp"
    data-sizes="auto"
    alt="Asu1tty"
    class="lazyload"
  />
  <div class="sidebar-author-name">Asu1tty</div>
  <div class="sidebar-description">逆向小白学习中...</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>文章</div><div class="sidebar-state-number">14</div>
  </div>
  <a class="sidebar-state-category" href="/categories/" aria-label="sidebar-state-category-link">
    <div>分类</div>
    <div class="sidebar-state-number">
      5
    </div>
  </a>
  <a class="sidebar-state-tag" href="/tags/" aria-label="sidebar-state-tag-link">
    <div>标签</div>
    <div class="sidebar-state-number">14</div>
  </a>
</div>
<div class="sidebar-social"></div>
<div class="sidebar-menu"><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="首页"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">首页</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="归档"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">归档</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/about"
        aria-label="关于"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">关于</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/friend"
        aria-label="友链"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">友链</div>
    </div></div>
</div><div class="sidebar-btn-wrapper" style="position:static">
            <div class="sidebar-toc-btn current"></div>
            <div class="sidebar-common-btn"></div>
          </div></div>
  </div>

  <div class="sidebar-widget"></div></aside>
<section id="main"><article
  class="h-entry article"
  itemprop="blogPost"
  itemscope
  itemtype="https://schema.org/BlogPosting"
>
  <div
    class="article-inner"
    data-aos="fade-up"
  >
    <div class="article-meta"><div class="article-date">
  <span
    class="article-date-link"
    data-aos="zoom-in"
  >
    <time datetime="2025-05-01 11:20:50 &#43;0800 &#43;0800" itemprop="datePublished"
      >2025-05-01</time
    >
    <time style="display: none;" id="post-update-time"
      >2025-05-01</time
    >
  </span>
</div>
<div class="article-category"><a
      class="article-category-link"
      href="/categories/aosp"
      data-aos="zoom-in"
      >AOSP</a
    ></div>
</div>
    <div class="hr-line"></div><div class="e-content article-entry" itemprop="articleBody"><p>本次分析AOSP 的源码的安卓版本为 <code>android-12.0.0_r34</code></p>
<h2 id="1-java层调用">
<a class="header-anchor" href="#1-java%e5%b1%82%e8%b0%83%e7%94%a8"></a>
1. java层调用
</h2><p>So在java层的加载方式有两种</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">System</span><span class="p">.</span><span class="na">loadLibrary</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">libName</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>或</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">System</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h3 id="11-systemload">
<a class="header-anchor" href="#11-systemload"></a>
1.1. System.load()
</h3><p>这里我们以<code>System.load</code>作为分析入口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// libcore/ojluni/src/main/java/java/lang/System.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Loads the native library specified by the filename argument.  The filename
</span></span></span><span class="line"><span class="cl"><span class="cm">     * argument must be an absolute path name.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * If the filename argument, when stripped of any platform-specific library
</span></span></span><span class="line"><span class="cl"><span class="cm">     * prefix, path, and file extension, indicates a library whose name is,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * for example, L, and a native library called L is statically linked
</span></span></span><span class="line"><span class="cl"><span class="cm">     * with the VM, then the JNI_OnLoad_L function exported by the library
</span></span></span><span class="line"><span class="cl"><span class="cm">     * is invoked rather than attempting to load a dynamic library.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A filename matching the argument does not have to exist in the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * file system.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * See the JNI Specification for more details.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Otherwise, the filename argument is mapped to a native library image in
</span></span></span><span class="line"><span class="cl"><span class="cm">     * an implementation-dependent manner.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The call &lt;code&gt;System.load(name)&lt;/code&gt; is effectively equivalent
</span></span></span><span class="line"><span class="cl"><span class="cm">     * to the call:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;blockquote&gt;&lt;pre&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Runtime.getRuntime().load(name)
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;/pre&gt;&lt;/blockquote&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param      filename   the file to load.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @exception  SecurityException  if a security manager exists and its
</span></span></span><span class="line"><span class="cl"><span class="cm">     *             &lt;code&gt;checkLink&lt;/code&gt; method doesn&#39;t allow
</span></span></span><span class="line"><span class="cl"><span class="cm">     *             loading of the specified dynamic library
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @exception  UnsatisfiedLinkError  if either the filename is not an
</span></span></span><span class="line"><span class="cl"><span class="cm">     *             absolute path name, the native library is not statically
</span></span></span><span class="line"><span class="cl"><span class="cm">     *             linked with the VM, or the library cannot be mapped to
</span></span></span><span class="line"><span class="cl"><span class="cm">     *             a native library image by the host system.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @exception  NullPointerException if &lt;code&gt;filename&lt;/code&gt; is
</span></span></span><span class="line"><span class="cl"><span class="cm">     *             &lt;code&gt;null&lt;/code&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see        java.lang.Runtime#load(java.lang.String)
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see        java.lang.SecurityManager#checkLink(java.lang.String)
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@CallerSensitive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">load0</span><span class="p">(</span><span class="n">Reflection</span><span class="p">.</span><span class="na">getCallerClass</span><span class="p">(),</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>其中，<code>Reflection.getCallerClass()</code> 是一个内部方法，定义在 <code>sun.reflect.Reflection</code> 类中（属于 JDK/ART 的私有 API）。它的作用是<strong>返回调用当前方法的类的 <code>Class</code> 对象</strong>，即调用栈中调用者的类。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Class A -&gt; calls System.load() -&gt; calls Runtime.load0()
</span></span></code></pre></div><p>在 <code>System.load()</code> 方法中，<code>Reflection.getCallerClass()</code> 返回的是调用 <code>System.load()</code> 的类（例如 <code>Class A</code>）的 <code>Class</code> 对象。<code>Reflection.getCallerClass()</code> 会检查调用栈，跳过当前方法（<code>System.load</code>）和其直接调用者（<code>Runtime.getRuntime().load0</code>）所在的类，找到更上层的调用者类。</p>
<h3 id="12-runtimegetruntimeload0">
<a class="header-anchor" href="#12-runtimegetruntimeload0"></a>
1.2. Runtime.getRuntime().load0()
</h3><p>在<code>Runtime.getRuntime().load0()</code>中进行了 <code>filename</code> 是否是 绝对路径 以及 空字符串 的检查之后，便开始调用 <code>nativeLoad</code> 真正的去加载 so 了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// libcore/ojluni/src/main/java/java/lang/Runtime.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">load0</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">fromClass</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">).</span><span class="na">isAbsolute</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnsatisfiedLinkError</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;Expecting an absolute path of the library: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NullPointerException</span><span class="p">(</span><span class="s">&#34;filename == null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nativeLoad</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">fromClass</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnsatisfiedLinkError</span><span class="p">(</span><span class="n">error</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="13-runtimejava-中的-nativeload">
<a class="header-anchor" href="#13-runtimejava-%e4%b8%ad%e7%9a%84-nativeload"></a>
1.3. Runtime.java 中的 nativeLoad()
</h3><p>在<code>java</code>层的<code>nativeLoad()</code>调用了<code>native</code>层的<code>nativeLoad()</code>，从这里正式进入native层部分</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// libcore/ojluni/src/main/java/java/lang/Runtime.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">nativeLoad</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">nativeLoad</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">nativeLoad</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">caller</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h2 id="2-so层调用">
<a class="header-anchor" href="#2-so%e5%b1%82%e8%b0%83%e7%94%a8"></a>
2. so层调用
</h2><h3 id="21-runtimec-中的-nativeload">
<a class="header-anchor" href="#21-runtimec-%e4%b8%ad%e7%9a%84-nativeload"></a>
2.1. Runtime.c 中的 nativeLoad()
</h3><p>调用了<code>JVM_NativeLoad()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// libcore/ojluni/src/main/native/Runtime.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
</span></span><span class="line"><span class="cl"><span class="nf">Runtime_nativeLoad</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">ignored</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">javaFilename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">jobject</span> <span class="n">javaLoader</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">caller</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">JVM_NativeLoad</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">javaFilename</span><span class="p">,</span> <span class="n">javaLoader</span><span class="p">,</span> <span class="n">caller</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="22-jvm_nativeload">
<a class="header-anchor" href="#22-jvm_nativeload"></a>
2.2. JVM_NativeLoad()
</h3><p>调用了<code>LoadNativeLibrary()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// android-platform\art\openjdkjvm\OpenjdkJvm.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="nf">JVM_NativeLoad</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">jstring</span> <span class="n">javaFilename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">jobject</span> <span class="n">javaLoader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">jclass</span> <span class="n">caller</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 实例化一个文件对象                               
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ScopedUtfChars</span> <span class="nf">filename</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">javaFilename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="nf">c_str</span><span class="p">()</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取当前进程的 javaVM 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">art</span><span class="o">::</span><span class="n">JavaVMExt</span><span class="o">*</span> <span class="n">vm</span> <span class="o">=</span> <span class="n">art</span><span class="o">::</span><span class="n">Runtime</span><span class="o">::</span><span class="nf">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">GetJavaVM</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="nf">LoadNativeLibrary</span><span class="p">(</span><span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">filename</span><span class="p">.</span><span class="nf">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">javaLoader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">caller</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="o">&amp;</span><span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Don&#39;t let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">env</span><span class="o">-&gt;</span><span class="nf">ExceptionClear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="nf">NewStringUTF</span><span class="p">(</span><span class="n">error_msg</span><span class="p">.</span><span class="nf">c_str</span><span class="p">());</span>
</span></span></code></pre></div><h3 id="23-loadnativelibrary">
<a class="header-anchor" href="#23-loadnativelibrary"></a>
2.3. LoadNativeLibrary()
</h3><p><code>LoadNativeLibrary</code>的代码较长，分段分析</p>
<h4 id="231-初始检查和重复加载检查">
<a class="header-anchor" href="#231-%e5%88%9d%e5%a7%8b%e6%a3%80%e6%9f%a5%e5%92%8c%e9%87%8d%e5%a4%8d%e5%8a%a0%e8%bd%bd%e6%a3%80%e6%9f%a5"></a>
2.3.1. 初始检查和重复加载检查
</h4><p>使用 <code>Thread::Current()</code> 获取当前线程。通过互斥锁 <code>MutexLock</code> 保护对共享库列表的访问（<code>libraries_</code> 是一个全局映射，存储已加载的库）。<code>libraries_-&gt;Get(path)</code> 检查指定路径的库是否已加载，若已加载，则返回对应的 <code>SharedLibrary</code> 对象，否则返回 <code>nullptr</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// art/runtime/jni/java_vm_ext.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">error_msg</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// See if we&#39;ve already loaded this library.  If we have, and the class loader
</span></span></span><span class="line"><span class="cl"><span class="c1">// matches, return successfully without doing anything.
</span></span></span><span class="line"><span class="cl"><span class="c1">// TODO: for better results we should canonicalize the pathname (or even compare
</span></span></span><span class="line"><span class="cl"><span class="c1">// inodes). This implementation is fine if everybody is using System.loadLibrary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SharedLibrary</span><span class="o">*</span> <span class="n">library</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span><span class="o">*</span> <span class="n">self</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">::</span><span class="n">Current</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// TODO: move the locking (and more of this logic) into Libraries.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">MutexLock</span> <span class="nf">mu</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">Locks</span><span class="o">::</span><span class="n">jni_libraries_lock_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">library</span> <span class="o">=</span> <span class="n">libraries_</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="232-类加载器和分配器的处理">
<a class="header-anchor" href="#232-%e7%b1%bb%e5%8a%a0%e8%bd%bd%e5%99%a8%e5%92%8c%e5%88%86%e9%85%8d%e5%99%a8%e7%9a%84%e5%a4%84%e7%90%86"></a>
2.3.2. 类加载器和分配器的处理
</h4><p><code>class_linker-&gt;IsBootClassLoader(soa, loader.Ptr())</code> 检查是否为引导类加载器（BootClassLoader）。特殊处理 BootClassLoader，并获取调用者类的 Dex 文件路径</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// art/runtime/jni/java_vm_ext.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="n">class_loader_allocator</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">caller_location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ScopedObjectAccess</span> <span class="nf">soa</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjPtr</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&gt;</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">soa</span><span class="p">.</span><span class="n">Decode</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&gt;</span><span class="p">(</span><span class="n">class_loader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ClassLinker</span><span class="o">*</span> <span class="n">class_linker</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetClassLinker</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">class_linker</span><span class="o">-&gt;</span><span class="n">IsBootClassLoader</span><span class="p">(</span><span class="n">soa</span><span class="p">,</span> <span class="n">loader</span><span class="p">.</span><span class="n">Ptr</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">loader</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">class_loader</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">caller_class</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjPtr</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">caller</span> <span class="o">=</span> <span class="n">soa</span><span class="p">.</span><span class="n">Decode</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span><span class="p">(</span><span class="n">caller_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjPtr</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">DexCache</span><span class="o">&gt;</span> <span class="n">dex_cache</span> <span class="o">=</span> <span class="n">caller</span><span class="o">-&gt;</span><span class="n">GetDexCache</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dex_cache</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">caller_location</span> <span class="o">=</span> <span class="n">dex_cache</span><span class="o">-&gt;</span><span class="n">GetLocation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ToModifiedUtf8</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">class_loader_allocator</span> <span class="o">=</span> <span class="n">class_linker</span><span class="o">-&gt;</span><span class="n">GetAllocatorForClassLoader</span><span class="p">(</span><span class="n">loader</span><span class="p">.</span><span class="n">Ptr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="n">class_loader_allocator</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="233-处理已加载的库">
<a class="header-anchor" href="#233-%e5%a4%84%e7%90%86%e5%b7%b2%e5%8a%a0%e8%bd%bd%e7%9a%84%e5%ba%93"></a>
2.3.3. 处理已加载的库
</h4><p>如果库已加载（library != nullptr），比较其分配器与当前类加载器的分配器,,如果请求加载的 ClassLoader 与之前加载的不同（通过比较分配器标识判断），则构造一个详细的错误信息，记录警告日志，并返回加载失败。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// art/runtime/jni/java_vm_ext.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">library</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">GetClassLoaderAllocator</span><span class="p">()</span> <span class="o">!=</span> <span class="n">class_loader_allocator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">call_to_string</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">jobject</span> <span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="s">&#34;null&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ScopedLocalRef</span><span class="o">&lt;</span><span class="n">jobject</span><span class="o">&gt;</span> <span class="n">local_ref</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewLocalRef</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">local_ref</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ScopedLocalRef</span><span class="o">&lt;</span><span class="n">jclass</span><span class="o">&gt;</span> <span class="n">local_class</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectClass</span><span class="p">(</span><span class="n">local_ref</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">                <span class="n">jmethodID</span> <span class="n">to_string</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">local_class</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">&#34;toString&#34;</span><span class="p">,</span> <span class="s">&#34;()Ljava/lang/String;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ScopedLocalRef</span><span class="o">&lt;</span><span class="n">jobject</span><span class="o">&gt;</span> <span class="n">local_string</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">local_ref</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">to_string</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">local_string</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ScopedUtfChars</span> <span class="nf">utf</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jstring</span><span class="o">&gt;</span><span class="p">(</span><span class="n">local_string</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">utf</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="n">utf</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionDescribe</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionClear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s">&#34;(Error calling toString)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s">&#34;null&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">old_class_loader</span> <span class="o">=</span> <span class="n">call_to_string</span><span class="p">(</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">GetClassLoader</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">new_class_loader</span> <span class="o">=</span> <span class="n">call_to_string</span><span class="p">(</span><span class="n">class_loader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringAppendF</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="s">&#34;Shared library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> already opened by &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;ClassLoader %p(%s); can&#39;t open in ClassLoader %p(%s)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">library</span><span class="o">-&gt;</span><span class="n">GetClassLoader</span><span class="p">(),</span> <span class="n">old_class_loader</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">class_loader</span><span class="p">,</span> <span class="n">new_class_loader</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">VLOG</span><span class="p">(</span><span class="n">jni</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[Shared library </span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s"> already loaded in ClassLoader &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">class_loader</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;]&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">CheckOnLoadResult</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringAppendF</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="s">&#34;JNI_OnLoad failed on a previous attempt to load </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="234-加载新库opennativelibrary">
<a class="header-anchor" href="#234-%e5%8a%a0%e8%bd%bd%e6%96%b0%e5%ba%93opennativelibrary"></a>
2.3.4. 加载新库OpenNativeLibrary
</h4><p>这部分代码在 library == nullptr 时执行，即库尚未被加载。正是我们需要分析的部分，<strong><code>android::OpenNativeLibrary</code></strong> 调用底层 dlopen 打开本地库，传入参数包括目标 SDK 版本、路径、类加载器等。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// art/runtime/jni/java_vm_ext.cc
</span></span></span><span class="line"><span class="cl"><span class="c1">// Open the shared library.  Because we&#39;re using a full path, the system
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// doesn&#39;t have to search through LD_LIBRARY_PATH.  (It may do so to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// resolve this library&#39;s dependencies though.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Failures here are expected when java.library.path has several entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and we have to hunt for the lib.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// class unloading. Libraries will only be unloaded when the reference count (incremented by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// dlopen) becomes zero from dlclose.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Retrieve the library path from the classloader, if necessary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ScopedLocalRef</span><span class="o">&lt;</span><span class="n">jstring</span><span class="o">&gt;</span> <span class="n">library_path</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">GetLibrarySearchPath</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">class_loader</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Locks</span><span class="o">::</span><span class="n">mutator_lock_</span><span class="o">-&gt;</span><span class="n">AssertNotHeld</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path_str</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="k">nullptr</span> <span class="o">:</span> <span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">needs_native_bridge</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span><span class="o">*</span> <span class="n">nativeloader_error_msg</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">android</span><span class="o">::</span><span class="n">OpenNativeLibrary</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">runtime_</span><span class="o">-&gt;</span><span class="n">GetTargetSdkVersion</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="n">path_str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">caller_location</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="k">nullptr</span> <span class="o">:</span> <span class="n">caller_location</span><span class="p">.</span><span class="n">c_str</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">      <span class="n">library_path</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">needs_native_bridge</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">nativeloader_error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">VLOG</span><span class="p">(</span><span class="n">jni</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[Call to dlopen(</span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">, RTLD_NOW) returned &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">handle</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;]&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">nativeloader_error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">android</span><span class="o">::</span><span class="n">NativeLoaderFreeErrorMessage</span><span class="p">(</span><span class="n">nativeloader_error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">VLOG</span><span class="p">(</span><span class="n">jni</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;dlopen(</span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">, RTLD_NOW) failed: &#34;</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">()</span> <span class="o">==</span> <span class="n">JNI_TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unexpected exception:&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionDescribe</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionClear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h4 id="235-创建-sharedlibrary-对象">
<a class="header-anchor" href="#235-%e5%88%9b%e5%bb%ba-sharedlibrary-%e5%af%b9%e8%b1%a1"></a>
2.3.5. 创建 SharedLibrary 对象
</h4><p>构造一个 SharedLibrary 对象，包含库的路径、句柄等信息。在锁内检查是否其他线程已添加该库。如果没有（<code>library == nullptr</code>），将新库加入 <code>libraries_</code>。若输掉竞争（!created_library），说明其他线程已添加库，返回已有库的加载结果。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// art/runtime/jni/java_vm_ext.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">created_library</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SharedLibrary</span><span class="o">&gt;</span> <span class="n">new_library</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">SharedLibrary</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">needs_native_bridge</span><span class="p">,</span> <span class="n">class_loader</span><span class="p">,</span> <span class="n">class_loader_allocator</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">MutexLock</span> <span class="nf">mu</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">Locks</span><span class="o">::</span><span class="n">jni_libraries_lock_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">library</span> <span class="o">=</span> <span class="n">libraries_</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">library</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">library</span> <span class="o">=</span> <span class="n">new_library</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">libraries_</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">library</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">created_library</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">created_library</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;WOW: we lost a race to add shared library: &#34;</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s"> ClassLoader=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">class_loader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">library</span><span class="o">-&gt;</span><span class="n">CheckOnLoadResult</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">VLOG</span><span class="p">(</span><span class="n">jni</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[Added shared library </span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s"> for ClassLoader &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">class_loader</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;]&#34;</span><span class="p">;</span>
</span></span></code></pre></div><h4 id="236-调用-jni_onload">
<a class="header-anchor" href="#236-%e8%b0%83%e7%94%a8-jni_onload"></a>
2.3.6. 调用 JNI_OnLoad
</h4><p><code>FindSymbol</code> 检查库中是否有 <code>JNI_OnLoad</code> 函数。
<strong>无 JNI_OnLoad</strong>：直接认为加载成功。
<strong>调用 JNI_OnLoad</strong>：</p>
<ul>
<li>保存并设置类加载器覆盖，确保 <code>JNI_OnLoad</code> 使用正确的类加载器。</li>
<li>调用 <code>JNI_OnLoad</code>，获取返回的 <code>JNI</code> 版本号。</li>
<li>根据 <code>SDK</code> 版本，可能调整信号链（<code>EnsureFrontOfChain</code>）。</li>
<li>恢复原始类加载器。
<strong>结果判断</strong>：</li>
<li>返回 <code>JNI_ERR</code>：加载失败。</li>
<li>返回错误的 <code>JNI</code> 版本：加载失败。</li>
<li>否则：加载成功。
<strong>设置并返回结果</strong>：将加载结果存储到 <code>library</code> 并返回。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// art/runtime/jni/java_vm_ext.cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">was_successful</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">sym</span> <span class="o">=</span> <span class="n">library</span><span class="o">-&gt;</span><span class="n">FindSymbol</span><span class="p">(</span><span class="s">&#34;JNI_OnLoad&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">VLOG</span><span class="p">(</span><span class="n">jni</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[No JNI_OnLoad found in </span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">]&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">was_successful</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ScopedLocalRef</span><span class="o">&lt;</span><span class="n">jobject</span><span class="o">&gt;</span> <span class="n">old_class_loader</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewLocalRef</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">GetClassLoaderOverride</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">self</span><span class="o">-&gt;</span><span class="n">SetClassLoaderOverride</span><span class="p">(</span><span class="n">class_loader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">VLOG</span><span class="p">(</span><span class="n">jni</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[Calling JNI_OnLoad in </span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">]&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">using</span> <span class="n">JNI_OnLoadFn</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">JavaVM</span><span class="o">*</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">JNI_OnLoadFn</span> <span class="n">jni_on_load</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">JNI_OnLoadFn</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">jni_on_load</span><span class="p">)(</span><span class="k">this</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">IsSdkVersionSetAndAtMost</span><span class="p">(</span><span class="n">runtime_</span><span class="o">-&gt;</span><span class="n">GetTargetSdkVersion</span><span class="p">(),</span> <span class="n">SdkVersion</span><span class="o">::</span><span class="n">kL</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">EnsureFrontOfChain</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">self</span><span class="o">-&gt;</span><span class="n">SetClassLoaderOverride</span><span class="p">(</span><span class="n">old_class_loader</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="n">JNI_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringAppendF</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="s">&#34;JNI_ERR returned from JNI_OnLoad in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">JavaVMExt</span><span class="o">::</span><span class="n">IsBadJniVersion</span><span class="p">(</span><span class="n">version</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringAppendF</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="s">&#34;Bad JNI version returned from JNI_OnLoad in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: %d&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">was_successful</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">VLOG</span><span class="p">(</span><span class="n">jni</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[Returned &#34;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">was_successful</span> <span class="o">?</span> <span class="s">&#34;successfully&#34;</span> <span class="o">:</span> <span class="s">&#34;failure&#34;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; from JNI_OnLoad in </span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">]&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">library</span><span class="o">-&gt;</span><span class="n">SetResult</span><span class="p">(</span><span class="n">was_successful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">was_successful</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="24-androidopennativelibrary">
<a class="header-anchor" href="#24-androidopennativelibrary"></a>
2.4. android::OpenNativeLibrary()
</h3><p>这个函数中有条件编译，接下来我们分析的是 <code>ART_TARGET_ANDROID</code> 的编译条件分支。
跟踪 <code>path</code> 参数，可以发现它被传入到了 <code>android_dlopen_ext(const char* filename, int flag, const android_dlextinfo* extinfo)</code> 函数中， <code>flag</code> <code>RTLD_NOW</code> 的含义是立即解析所有符号，并在加载时报告任何解析错误</p>
<ul>
<li>RTLD_NOW
立即解析所有符号，并在加载时报告任何解析错误</li>
<li>RTLD_LAZY
只在符号首次使用时解析</li>
<li>RTLD_GLOBAL
将库及其符号添加到全局命名空间中，以便其他库可以使用这些符号</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// art/libnativeloader/native_loader.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">OpenNativeLibrary</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">target_sdk_version</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">jobject</span> <span class="n">class_loader</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">caller_location</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">library_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">bool</span><span class="o">*</span> <span class="n">needs_native_bridge</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">error_msg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(ART_TARGET_ANDROID)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">UNUSED</span><span class="p">(</span><span class="n">target_sdk_version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">class_loader</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">needs_native_bridge</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">caller_location</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">boot_namespace</span> <span class="o">=</span> <span class="n">FindExportedNamespace</span><span class="p">(</span><span class="n">caller_location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">boot_namespace</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">android_dlextinfo</span> <span class="n">dlextinfo</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ANDROID_DLEXT_USE_NAMESPACE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">library_namespace</span> <span class="o">=</span> <span class="n">boot_namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">android_dlopen_ext</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">RTLD_NOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dlextinfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">dlerror</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if the library is in NATIVELOADER_DEFAULT_NAMESPACE_LIBS and should
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// be loaded from the kNativeloaderExtraLibs namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Result</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">TryLoadNativeloaderExtraLib</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">error</span><span class="p">().</span><span class="n">message</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">value</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">handle</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Fall back to the system namespace. This happens for preloaded JNI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// libraries in the zygote.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO(b/185833744): Investigate if this should fall back to the app main
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// namespace (aka anonymous namespace) instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">OpenSystemLibrary</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">RTLD_NOW</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">dlerror</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">guard</span><span class="p">(</span><span class="n">g_namespaces_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">NativeLoaderNamespace</span><span class="o">*</span> <span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">ns</span> <span class="o">=</span> <span class="n">g_namespaces</span><span class="o">-&gt;</span><span class="n">FindNamespaceByClassLoader</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">class_loader</span><span class="p">))</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// This is the case where the classloader was not created by ApplicationLoaders
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// In this case we create an isolated not-shared namespace for it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Result</span><span class="o">&lt;</span><span class="n">NativeLoaderNamespace</span><span class="o">*&gt;</span> <span class="n">isolated_ns</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">CreateClassLoaderNamespaceLocked</span><span class="p">(</span><span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">target_sdk_version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">class_loader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="cm">/*is_shared=*/</span><span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="cm">/*dex_path=*/</span><span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">library_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="cm">/*permitted_path=*/</span><span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="cm">/*uses_library_list=*/</span><span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isolated_ns</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">isolated_ns</span><span class="p">.</span><span class="n">error</span><span class="p">().</span><span class="n">message</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ns</span> <span class="o">=</span> <span class="o">*</span><span class="n">isolated_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">OpenNativeLibraryInNamespace</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">needs_native_bridge</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="25-android_dlopen_ext">
<a class="header-anchor" href="#25-android_dlopen_ext"></a>
2.5. android_dlopen_ext()
</h3><p><code>android_dlopen_ext</code> 调用了 <code>__loader_android_dlopen_ext</code>
在代码的第四行出现了内建函数 <code>builtin_return_address(LEVEL)</code> , 这个函数用来返回当前函数或调用者的返回地址。函数的参数 LEVEL 表示函数调用链中的不同层次的函数，各个值代表的意义如下:</p>
<ul>
<li>0：返回当前函数的返回地址；</li>
<li>1：返回当前函数调用者的返回地址；</li>
<li>2：返回当前函数调用者的调用者的返回地址；</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/libdl/libdl.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">__weak__</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">android_dlopen_ext</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">caller_addr</span> <span class="o">=</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">__loader_android_dlopen_ext</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">extinfo</span><span class="p">,</span> <span class="n">caller_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="26-__loader_android_dlopen_ext">
<a class="header-anchor" href="#26-__loader_android_dlopen_ext"></a>
2.6. __loader_android_dlopen_ext()
</h3><p>调用了<code>dlopen_ext</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/dlfcn.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">__loader_android_dlopen_ext</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">caller_addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dlopen_ext</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">extinfo</span><span class="p">,</span> <span class="n">caller_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="27-dlopen_ext">
<a class="header-anchor" href="#27-dlopen_ext"></a>
2.7. dlopen_ext
</h3><p>调用了<code>do_dlopen</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/dlfcn.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">dlopen_ext</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">caller_addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedPthreadMutexLocker</span> <span class="n">locker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_dl_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">g_linker_logger</span><span class="p">.</span><span class="n">ResetState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">do_dlopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">extinfo</span><span class="p">,</span> <span class="n">caller_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__bionic_format_dlerror</span><span class="p">(</span><span class="s">&#34;dlopen failed&#34;</span><span class="p">,</span> <span class="n">linker_get_error_buffer</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="28-do_dlopen">
<a class="header-anchor" href="#28-do_dlopen"></a>
2.8. do_dlopen
</h3><p>其中<code>find_library</code>函数帮助完成so的加载</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">do_dlopen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">caller_addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">trace_prefix</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;dlopen: &#34;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="s">&#34;(nullptr)&#34;</span> <span class="o">:</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="n">trace</span><span class="p">(</span><span class="n">trace_prefix</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">ScopedTrace</span> <span class="n">loading_trace</span><span class="p">((</span><span class="n">trace_prefix</span> <span class="o">+</span> <span class="s">&#34; - loading and linking&#34;</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">soinfo</span><span class="o">*</span> <span class="k">const</span> <span class="n">caller</span> <span class="o">=</span> <span class="n">find_containing_library</span><span class="p">(</span><span class="n">caller_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">get_caller_namespace</span><span class="p">(</span><span class="n">caller</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;dlopen(name=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, flags=0x%x, extinfo=%s, caller=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, caller_ns=%s@%p, targetSdkVersion=%i) ...&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">android_dlextinfo_to_string</span><span class="p">(</span><span class="n">extinfo</span><span class="p">).</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">         <span class="n">caller</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="s">&#34;(null)&#34;</span> <span class="o">:</span> <span class="n">caller</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">         <span class="n">ns</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="s">&#34;(null)&#34;</span> <span class="o">:</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">         <span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">get_application_target_sdk_version</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">purge_guard</span> <span class="o">=</span> <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">make_scope_guard</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span> <span class="n">purge_unused_memory</span><span class="p">();</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">failure_guard</span> <span class="o">=</span> <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">make_scope_guard</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span> <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;... dlopen failed: %s&#34;</span><span class="p">,</span> <span class="n">linker_get_error_buffer</span><span class="p">());</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">RTLD_NOW</span><span class="o">|</span><span class="n">RTLD_LAZY</span><span class="o">|</span><span class="n">RTLD_LOCAL</span><span class="o">|</span><span class="n">RTLD_GLOBAL</span><span class="o">|</span><span class="n">RTLD_NODELETE</span><span class="o">|</span><span class="n">RTLD_NOLOAD</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;invalid flags to dlopen: %x&#34;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ANDROID_DLEXT_VALID_FLAG_BITS</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;invalid extended flags to android_dlopen_ext: 0x%&#34;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_USE_LIBRARY_FD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;invalid extended flag combination (ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET without &#34;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;ANDROID_DLEXT_USE_LIBRARY_FD): 0x%&#34;</span> <span class="n">PRIx64</span><span class="p">,</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_USE_NAMESPACE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">library_namespace</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;ANDROID_DLEXT_USE_NAMESPACE is set but extinfo-&gt;library_namespace is null&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">ns</span> <span class="o">=</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">library_namespace</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Workaround for dlopen(/system/lib/&lt;soname&gt;) when .so is in /apex. http://b/121248172
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// The workaround works only when targetSdkVersion &lt; Q.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name_to_apex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">translateSystemPathToApexPath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name_to_apex</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">new_name</span> <span class="o">=</span> <span class="n">name_to_apex</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;dlopen considering translation from %s to APEX path %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">new_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Some APEXs could be optionally disabled. Only translate the path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// when the old file is absent and the new file exists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO(b/124218500): Re-enable it once app compat issue is resolved
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    if (file_exists(name)) {
</span></span></span><span class="line"><span class="cl"><span class="cm">      LD_LOG(kLogDlopen, &#34;dlopen %s exists, not translating&#34;, name);
</span></span></span><span class="line"><span class="cl"><span class="cm">    } else
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file_exists</span><span class="p">(</span><span class="n">new_name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;dlopen %s does not exist, not translating&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">new_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;dlopen translation accepted: using %s&#34;</span><span class="p">,</span> <span class="n">new_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// End Workaround for dlopen(/system/lib/&lt;soname&gt;) when .so is in /apex.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">asan_name_holder</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">translated_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">g_is_asan</span> <span class="o">&amp;&amp;</span> <span class="n">translated_name</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">translated_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">original_path</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">realpath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">original_path</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">asan_name_holder</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">kAsanLibDirPrefix</span><span class="p">)</span> <span class="o">+</span> <span class="n">original_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">file_exists</span><span class="p">(</span><span class="n">asan_name_holder</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">find_loaded_library_by_realpath</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">original_path</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">PRINT</span><span class="p">(</span><span class="s">&#34;linker_asan dlopen NOT translating </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> -&gt; </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: library already loaded&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">asan_name_holder</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">PRINT</span><span class="p">(</span><span class="s">&#34;linker_asan dlopen translating </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> -&gt; </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">translated_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">translated_name</span> <span class="o">=</span> <span class="n">asan_name_holder</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ProtectedDataGuard</span> <span class="n">guard</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="n">find_library</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">translated_name</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">extinfo</span><span class="p">,</span> <span class="n">caller</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">loading_trace</span><span class="p">.</span><span class="n">End</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">si</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">to_handle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#34;... dlopen calling constructors: realpath=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, soname=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, handle=%p&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">(),</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_soname</span><span class="p">(),</span> <span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="o">-&gt;</span><span class="n">call_constructors</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">failure_guard</span><span class="p">.</span><span class="n">Disable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#34;... dlopen successful: realpath=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, soname=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, handle=%p&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">(),</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_soname</span><span class="p">(),</span> <span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="281-call_constructors">
<a class="header-anchor" href="#281-call_constructors"></a>
2.8.1. call_constructors
</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker_soinfo.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">soinfo</span><span class="o">::</span><span class="n">call_constructors</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">constructors_called</span> <span class="o">||</span> <span class="n">g_is_ldd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// We set constructors_called before actually calling the constructors, otherwise it doesn&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// protect against recursive constructor calls. One simple example of constructor recursion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// is the libc debug malloc, which is implemented in libc_malloc_debug_leak.so:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 1. The program depends on libc, so libc&#39;s constructor is called here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 2. The libc constructor calls dlopen() to load libc_malloc_debug_leak.so.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 3. dlopen() calls the constructors on the newly created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    soinfo for libc_malloc_debug_leak.so.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 4. The debug .so depends on libc, so CallConstructors is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    called again with the libc soinfo. If it doesn&#39;t trigger the early-
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    out above, the libc constructor will be called again (recursively!).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">constructors_called</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_main_executable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">preinit_array_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The GNU dynamic linker silently ignores these, but we warn the developer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PRINT</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: ignoring DT_PREINIT_ARRAY in shared library!&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">get_children</span><span class="p">().</span><span class="n">for_each</span><span class="p">([]</span> <span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="o">-&gt;</span><span class="n">call_constructors</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_linker</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bionic_trace_begin</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&#34;calling constructors: &#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">get_realpath</span><span class="p">()).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// DT_INIT should be called before DT_INIT_ARRAY if both are present.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">call_function</span><span class="p">(</span><span class="s">&#34;DT_INIT&#34;</span><span class="p">,</span> <span class="n">init_func_</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">call_array</span><span class="p">(</span><span class="s">&#34;DT_INIT_ARRAY&#34;</span><span class="p">,</span> <span class="n">init_array_</span><span class="p">,</span> <span class="n">init_array_count_</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_linker</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bionic_trace_end</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在一个so文件中，<code>.preinit_array</code>，<code>.init_array</code>，<code>.init</code>和<code>JNI_OnLoad</code>的执行顺序就是 <code>.preinit_array</code>，<code>.init</code>，<code>.init_array</code>，<code>JNI_OnLoad</code>。但是由于前面提到，在so中<code>.preinit_array</code>会被忽略，所以真正的执行顺序是<code>.init</code>，<code>.init_array</code>，<code>JNI_OnLoad</code>。</p>
<h3 id="29-find_library">
<a class="header-anchor" href="#29-find_library"></a>
2.9. find_library
</h3><p>调用了<code>find_libraries</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">soinfo</span><span class="o">*</span> <span class="nf">find_library</span><span class="p">(</span><span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rtld_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">soinfo</span><span class="o">*</span> <span class="n">needed_by</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span> <span class="o">=</span> <span class="n">solist_get_somain</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">find_libraries</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">needed_by</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">rtld_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">extinfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="nb">false</span> <span class="cm">/* add_as_children */</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">si</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">soinfo_unload</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">si</span><span class="o">-&gt;</span><span class="n">increment_ref_count</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">si</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="210-find_libraries">
<a class="header-anchor" href="#210-find_libraries"></a>
2.10. find_libraries
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">find_libraries</span><span class="p">(</span><span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">soinfo</span><span class="o">*</span> <span class="n">start_with</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">library_names</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size_t</span> <span class="n">library_names_count</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">soinfo</span><span class="o">*</span> <span class="n">soinfos</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">soinfo</span><span class="o">*&gt;*</span> <span class="n">ld_preloads</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size_t</span> <span class="n">ld_preloads_count</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">rtld_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">bool</span> <span class="n">add_as_children</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">android_namespace_t</span><span class="o">*&gt;*</span> <span class="n">namespaces</span><span class="p">)</span>
</span></span></code></pre></div><p>该函数可按照注释分为<code>step0 - step7</code>八个步骤</p>
<h4 id="2101-step-0-准备工作">
<a class="header-anchor" href="#2101-step-0-%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c"></a>
2.10.1. Step 0: 准备工作
</h4><p><strong>初始化数据结构</strong>：</p>
<ul>
<li><code>readers_map</code>：一个映射表，用于存储 soinfo 和对应的 <code>ElfReader</code>（用于解析 ELF 文件）。</li>
<li><code>load_tasks</code>：一个任务列表，用于管理所有需要加载的库。将待加载的 so 添加到 <code>LoadTaskList</code> 加载任务队列中
这一步为后续加载和链接做好准备，确保任务和输出数组就绪。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// Step 0: prepare.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">soinfo</span><span class="o">*</span><span class="p">,</span> <span class="n">ElfReader</span><span class="o">&gt;</span> <span class="n">readers_map</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">LoadTaskList</span> <span class="n">load_tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">library_names_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">library_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_tasks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">LoadTask</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">start_with</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readers_map</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// If soinfos array is null allocate one on stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// The array is needed in case of failure; for example
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// when library_names[] = {libone.so, libtwo.so} and libone.so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// is loaded correctly but libtwo.so failed for some reason.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// In this case libone.so should be unloaded on return.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// See also implementation of failure_guard below.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">soinfos</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">soinfos_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">library_names_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfos</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">soinfo</span><span class="o">**&gt;</span><span class="p">(</span><span class="n">alloca</span><span class="p">(</span><span class="n">soinfos_size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">memset</span><span class="p">(</span><span class="n">soinfos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">soinfos_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// list of libraries to link - see step 2.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">size_t</span> <span class="n">soinfos_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">scope_guard</span> <span class="o">=</span> <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">make_scope_guard</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">LoadTask</span><span class="o">*</span> <span class="nl">t</span> <span class="p">:</span> <span class="n">load_tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LoadTask</span><span class="o">::</span><span class="n">deleter</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ZipArchiveCache</span> <span class="n">zip_archive_cache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">soinfo_list_t</span> <span class="n">new_global_group_members</span><span class="p">;</span>
</span></span></code></pre></div><h4 id="2102-step-1-扩展加载任务列表">
<a class="header-anchor" href="#2102-step-1-%e6%89%a9%e5%b1%95%e5%8a%a0%e8%bd%bd%e4%bb%bb%e5%8a%a1%e5%88%97%e8%a1%a8"></a>
2.10.2. Step 1: 扩展加载任务列表
</h4><p>遍历 <code>load_tasks</code>，查找每个库并并将so库依赖（<code>DT_NEEDED</code>）的其他库也加入到load_tasks加载任务队列中。调用<code>find_library_internal</code> 查找库并更新 <code>load_tasks</code>（此时不加载，只解析依赖）。这一步确保所有相关库（包括依赖）都被识别并记录，<strong>但尚未加载到内存!</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// Step 1: expand the list of load_tasks to include
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// all DT_NEEDED libraries (do not load them just yet)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">load_tasks</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LoadTask</span><span class="o">*</span> <span class="n">task</span> <span class="o">=</span> <span class="n">load_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">needed_by</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">is_dt_needed</span> <span class="o">=</span> <span class="n">needed_by</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">needed_by</span> <span class="o">!=</span> <span class="n">start_with</span> <span class="o">||</span> <span class="n">add_as_children</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_extinfo</span><span class="p">(</span><span class="n">is_dt_needed</span> <span class="o">?</span> <span class="k">nullptr</span> <span class="o">:</span> <span class="n">extinfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_dt_needed</span><span class="p">(</span><span class="n">is_dt_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;find_libraries(ns=%s): task=%s, is_dt_needed=%d&#34;</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">           <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">is_dt_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Note: start from the namespace that is stored in the LoadTask. This namespace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is different from the current namespace when the LoadTask is for a transitive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dependency and the lib that created the LoadTask is not found in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// current namespace but in one of the linked namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">find_library_internal</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">android_namespace_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">get_start_from</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                               <span class="n">task</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="o">&amp;</span><span class="n">zip_archive_cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="o">&amp;</span><span class="n">load_tasks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">rtld_flags</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_soinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_dt_needed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">needed_by</span><span class="o">-&gt;</span><span class="n">add_child</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// When ld_preloads is not null, the first
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ld_preloads_count libs are in fact ld_preloads.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">is_ld_preload</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ld_preloads</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">soinfos_count</span> <span class="o">&lt;</span> <span class="n">ld_preloads_count</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ld_preloads</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">is_ld_preload</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">soinfos_count</span> <span class="o">&lt;</span> <span class="n">library_names_count</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">soinfos</span><span class="p">[</span><span class="n">soinfos_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add the new global group members to all initial namespaces. Do this secondary namespace setup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// at the same time that libraries are added to their primary namespace so that the order of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// global group members is the same in the every namespace. Only add a library to a namespace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// once, even if it appears multiple times in the dependency graph.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">is_ld_preload</span> <span class="o">||</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">get_dt_flags_1</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">DF_1_GLOBAL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">is_linked</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">namespaces</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">new_global_group_members</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">si</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_global_group_members</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">linked_ns</span> <span class="p">:</span> <span class="o">*</span><span class="n">namespaces</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">get_primary_namespace</span><span class="p">()</span> <span class="o">!=</span> <span class="n">linked_ns</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">linked_ns</span><span class="o">-&gt;</span><span class="n">add_soinfo</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">si</span><span class="o">-&gt;</span><span class="n">add_secondary_namespace</span><span class="p">(</span><span class="n">linked_ns</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h5 id="21021-find_library_internal">
<a class="header-anchor" href="#21021-find_library_internal"></a>
2.10.2.1. find_library_internal
</h5><p>主要做了以下四步</p>
<ul>
<li>
<p>调用 <code>find_loaded_library_by_soname</code>，根据库的 soname（共享对象名称）在当前命名空间及其链接的命名空间中查找有没有加载过，如果找到就设置 <code>task</code> 的 <code>soinfo</code> 为找到的库并且返回。</p>
</li>
<li>
<p>如果上一步没有找到，就使用更精确的 <code>load_library</code> 函数查找。<strong>再次强调，虽然函数名称叫 <code>load_library</code> ，但是它不负责将文件内容映射到内存 (mmap)。 实际的内存映射是在 <code>find_libraries</code> 的 Step 2 中由 task-&gt;load() 完成的。</strong> 这一步是加载库的主要尝试，负责解析库文件并处理其依赖关系。</p>
</li>
<li>
<p>为特定的系统库提供特殊处理，允许它们从默认命名空间加载。检查当前命名空间是否启用了豁免列表（<code>is_exempt_list_enabled()</code>）。检查目标库是否在豁免列表中（<code>is_exempt_lib()</code>）。如果满足条件，切换到全局默认命名空间（<code>g_default_namespace</code>），然后再次调用 <code>load_library</code>。</p>
</li>
<li>
<p>如果前面的尝试都失败，遍历当前命名空间的链接命名空间，尝试查找或加载库。遍历 <code>ns-&gt;linked_namespaces()</code> 中的每个链接命名空间。对每个命名空间调用 <code>find_library_in_linked_namespace</code> 检查库是否已加载。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">bool</span> <span class="nf">find_library_internal</span><span class="p">(</span><span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">LoadTask</span><span class="o">*</span> <span class="n">task</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">ZipArchiveCache</span><span class="o">*</span> <span class="n">zip_archive_cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">LoadTaskList</span><span class="o">*</span> <span class="n">load_tasks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="kt">int</span> <span class="n">rtld_flags</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">soinfo</span><span class="o">*</span> <span class="n">candidate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">find_loaded_library_by_soname</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="nb">true</span> <span class="cm">/* search_linked_namespaces */</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">&amp;</span><span class="n">candidate</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#34;find_library_internal(ns=%s, task=%s): Already loaded (by soname): %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">candidate</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_soinfo</span><span class="p">(</span><span class="n">candidate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Library might still be loaded, the accurate detection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// of this fact is done by load_library.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TRACE</span><span class="p">(</span><span class="s">&#34;[ </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> find_loaded_library_by_soname failed (*candidate=%s@%p). Trying harder... ]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">candidate</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="s">&#34;n/a&#34;</span> <span class="o">:</span> <span class="n">candidate</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">(),</span> <span class="n">candidate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">load_library</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">load_tasks</span><span class="p">,</span> <span class="n">rtld_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="nb">true</span> <span class="cm">/* search_linked_namespaces */</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// TODO(dimitry): workaround for http://b/26394120 (the exempt-list)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">is_exempt_list_enabled</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">is_exempt_lib</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// For the libs in the exempt-list, switch to the default namespace and then
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// try the load again from there. The library could be loaded from the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// default namespace or from another namespace (e.g. runtime) that is linked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// from the default namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#34;find_library_internal(ns=%s, task=%s): Exempt system library - trying namespace %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">g_default_namespace</span><span class="p">.</span><span class="n">get_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">ns</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g_default_namespace</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">load_library</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">load_tasks</span><span class="p">,</span> <span class="n">rtld_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="nb">true</span> <span class="cm">/* search_linked_namespaces */</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// END OF WORKAROUND
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// if a library was not found - look into linked namespaces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// preserve current dlerror in the case it fails.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">DlErrorRestorer</span> <span class="n">dlerror_restorer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;find_library_internal(ns=%s, task=%s): Trying %zu linked namespaces&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">linked_namespaces</span><span class="p">().</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">linked_namespace</span> <span class="p">:</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">linked_namespaces</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">find_library_in_linked_namespace</span><span class="p">(</span><span class="n">linked_namespace</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Library is already loaded.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">get_soinfo</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// n.b. This code path runs when find_library_in_linked_namespace found an already-loaded
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// library by soname. That should only be possible with a exempt-list lookup, where we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// switch the namespace, because otherwise, find_library_in_linked_namespace is duplicating
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the soname scan done in this function&#39;s first call to find_loaded_library_by_soname.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">load_library</span><span class="p">(</span><span class="n">linked_namespace</span><span class="p">.</span><span class="n">linked_namespace</span><span class="p">(),</span> <span class="n">task</span><span class="p">,</span> <span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">load_tasks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">rtld_flags</span><span class="p">,</span> <span class="nb">false</span> <span class="cm">/* search_linked_namespaces */</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;find_library_internal(ns=%s, task=%s): Found in linked namespace %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">linked_namespace</span><span class="p">.</span><span class="n">linked_namespace</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>既然如此，那么我们的so应该走<code>load_library</code></p>
<h5 id="21022-load_library">
<a class="header-anchor" href="#21022-load_library"></a>
2.10.2.2. load_library
</h5><p>在这个函数中，首先判断 <code>extinfo-&gt;flags</code> 是否是 <code>ANDROID_DLEXT_USE_LIBRARY_FD</code> , 如果同时有 <code>ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET</code> , 标志在 <a href="https://developer.android.com/ndk/reference/group/libdl" title="Android 官网的解释">Android 官网的解释</a>如下
<img src="https://cdn.jsdelivr.net/gh/Asu1tty/blog_img@master/picSource/20250501161743824.png" alt="">
那这样就方便了，假如已经有了这个 library 的 <code>fd</code> 文件描述符，那直接拿过来用就可以了</p>
<p>但是我们待加载的 so 的 <code>extinfo-&gt;flags</code> 已经在 <code>android::OpenNativeLibrary</code> 中被定义为 <code>ANDROID_DLEXT_USE_NAMESPACE</code> 了，这个标志的含义在上图中也有给出，所以很遗憾，这个 <code>if</code> 语句中的代码并不会被执行
<img src="https://cdn.jsdelivr.net/gh/Asu1tty/blog_img@master/picSource/20250501161835881.png" alt="">
那么为什么要特意在此处加入这个 if 语句呢？ <a href="https://oacia.dev/android-load-so/">作者</a>的理解是为了提高运行的效率，有一些底层的库已经打开过，加载过了，那么就完全没有必要再打开，搜索一次，直接把 library 的 fd 文件描述符拿过来用就可以了</p>
<p>不会走第一个if 语句，那么就是调用了<code>open_library</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">bool</span> <span class="nf">load_library</span><span class="p">(</span><span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">LoadTask</span><span class="o">*</span> <span class="n">task</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">ZipArchiveCache</span><span class="o">*</span> <span class="n">zip_archive_cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">LoadTaskList</span><span class="o">*</span> <span class="n">load_tasks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="kt">int</span> <span class="n">rtld_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="kt">bool</span> <span class="n">search_linked_namespaces</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">soinfo</span><span class="o">*</span> <span class="n">needed_by</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_extinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_USE_LIBRARY_FD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">off64_t</span> <span class="n">file_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">file_offset</span> <span class="o">=</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">library_fd_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">realpath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">realpath_fd</span><span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">library_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">realpath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_first_stage_init</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PRINT</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;warning: unable to get realpath for the library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> by extinfo-&gt;library_fd. &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Will use given name.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">realpath</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_fd</span><span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">library_fd</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_file_offset</span><span class="p">(</span><span class="n">file_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">load_library</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">load_tasks</span><span class="p">,</span> <span class="n">rtld_flags</span><span class="p">,</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">search_linked_namespaces</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;load_library(ns=%s, task=%s, flags=0x%x, search_linked_namespaces=%d): calling &#34;</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;open_library&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">rtld_flags</span><span class="p">,</span> <span class="n">search_linked_namespaces</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Open the file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">off64_t</span> <span class="n">file_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">realpath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open_library</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">needed_by</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">realpath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">is_dt_needed</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">needed_by</span><span class="o">-&gt;</span><span class="n">is_main_executable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> not found: needed by main executable&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> not found: needed by %s in namespace %s&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">needed_by</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">(),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_start_from</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> not found&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_file_offset</span><span class="p">(</span><span class="n">file_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">load_library</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">load_tasks</span><span class="p">,</span> <span class="n">rtld_flags</span><span class="p">,</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">search_linked_namespaces</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="21023-open_library">
<a class="header-anchor" href="#21023-open_library"></a>
2.10.2.3. open_library()
</h5><p>分析传入的是绝对路径的so，那么进入第一个 if 语句，即 <code>open_library_at_path</code> 。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">open_library</span><span class="p">(</span><span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ZipArchiveCache</span><span class="o">*</span> <span class="n">zip_archive_cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">soinfo</span> <span class="o">*</span><span class="n">needed_by</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">off64_t</span><span class="o">*</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">realpath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">TRACE</span><span class="p">(</span><span class="s">&#34;[ opening %s from namespace %s ]&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// If the name contains a slash, we should attempt to open it directly and not search the paths.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">open_library_at_path</span><span class="p">(</span><span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">realpath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// LD_LIBRARY_PATH has the highest priority. We don&#39;t have to check accessibility when searching
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// the namespace&#39;s path lists, because anything found on a namespace path list should always be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// accessible.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open_library_on_paths</span><span class="p">(</span><span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_ld_library_paths</span><span class="p">(),</span> <span class="n">realpath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Try the DT_RUNPATH, and verify that the library is accessible.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">needed_by</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="n">open_library_on_paths</span><span class="p">(</span><span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">needed_by</span><span class="o">-&gt;</span><span class="n">get_dt_runpath</span><span class="p">(),</span> <span class="n">realpath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">is_accessible</span><span class="p">(</span><span class="o">*</span><span class="n">realpath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Finally search the namespace&#39;s main search path list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="n">open_library_on_paths</span><span class="p">(</span><span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_default_library_paths</span><span class="p">(),</span> <span class="n">realpath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="21024-open_library_at_path">
<a class="header-anchor" href="#21024-open_library_at_path"></a>
2.10.2.4. open_library_at_path
</h5><p>在第二个 if 语句中使用<code>open</code>打开了so，并且返回了fd，那么返回到 <code>load_library</code> 看看使用fd做了什么操作。</p>
<p>进入到了另一个重载函数里</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">return</span> <span class="nf">load_library</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">load_tasks</span><span class="p">,</span> <span class="n">rtld_flags</span><span class="p">,</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">search_linked_namespaces</span><span class="p">);</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">open_library_at_path</span><span class="p">(</span><span class="n">ZipArchiveCache</span><span class="o">*</span> <span class="n">zip_archive_cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="n">off64_t</span><span class="o">*</span> <span class="n">file_offset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">realpath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果路径中包含 &#34;!/&#34;, 则通过 zipfile 打开库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">kZipFileSeparator</span><span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="n">open_library_in_zipfile</span><span class="p">(</span><span class="n">zip_archive_cache</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">realpath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">file_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">realpath_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">realpath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_first_stage_init</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">PRINT</span><span class="p">(</span><span class="s">&#34;warning: unable to get realpath for the library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">. Will use given path.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">realpath</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="21025-重载的load_library">
<a class="header-anchor" href="#21025-%e9%87%8d%e8%bd%bd%e7%9a%84load_library"></a>
2.10.2.5. 重载的load_library
</h5><p>前面是一堆的合法性检查，直到 <code>task-&gt;read(realpath.c_str(), file_stat.st_size)</code> 开始解析so</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">bool</span> <span class="nf">load_library</span><span class="p">(</span><span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">LoadTask</span><span class="o">*</span> <span class="n">task</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">LoadTaskList</span><span class="o">*</span> <span class="n">load_tasks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="kt">int</span> <span class="n">rtld_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">realpath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="kt">bool</span> <span class="n">search_linked_namespaces</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">off64_t</span> <span class="n">file_offset</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_file_offset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_extinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;load_library(ns=%s, task=%s, flags=0x%x, realpath=%s, search_linked_namespaces=%d)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">rtld_flags</span><span class="p">,</span> <span class="n">realpath</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">search_linked_namespaces</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">file_offset</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;file offset for the library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> is not page-aligned: %&#34;</span> <span class="n">PRId64</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">file_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;file offset for the library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> is negative: %&#34;</span> <span class="n">PRId64</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="nc">stat</span> <span class="n">file_stat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">get_fd</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">file_stat</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;unable to stat file for the library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: %s&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">file_offset</span> <span class="o">&gt;=</span> <span class="n">file_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;file offset for the library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> &gt;= file size: %&#34;</span> <span class="n">PRId64</span> <span class="s">&#34; &gt;= %&#34;</span> <span class="n">PRId64</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">file_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Check for symlink and other situations where
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// file can have different names, unless ANDROID_DLEXT_FORCE_LOAD is set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_FORCE_LOAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">find_loaded_library_by_inode</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">file_stat</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">search_linked_namespaces</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="s">&#34;load_library(ns=%s, task=%s): Already loaded under different name/path </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> - &#34;</span>
</span></span><span class="line"><span class="cl">             <span class="s">&#34;will return existing soinfo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_soinfo</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">rtld_flags</span> <span class="o">&amp;</span> <span class="n">RTLD_NOLOAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> wasn&#39;t loaded and RTLD_NOLOAD prevented it&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="nc">statfs</span> <span class="n">fs_stat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">fstatfs</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">get_fd</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">fs_stat</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;unable to fstatfs file for the library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: %s&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// do not check accessibility using realpath if fd is located on tmpfs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// this enables use of memfd_create() for apps
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">fs_stat</span><span class="p">.</span><span class="n">f_type</span> <span class="o">!=</span> <span class="n">TMPFS_MAGIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">is_accessible</span><span class="p">(</span><span class="n">realpath</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO(dimitry): workaround for http://b/26394120 - the exempt-list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO(dimitry) before O release: add a namespace attribute to have this enabled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// only for classloader-namespaces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">soinfo</span><span class="o">*</span> <span class="n">needed_by</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">is_dt_needed</span><span class="p">()</span> <span class="o">?</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">()</span> <span class="o">:</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_exempt_lib</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">needed_by</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// print warning only if needed by non-system library
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">needed_by</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_system_library</span><span class="p">(</span><span class="n">needed_by</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">soinfo</span><span class="o">*</span> <span class="n">needed_or_dlopened_by</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sopath</span> <span class="o">=</span> <span class="n">needed_or_dlopened_by</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="s">&#34;(unknown)&#34;</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">needed_or_dlopened_by</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_WARN_documented_change</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="s">&#34;private-api-enforced-for-api-level-24&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="s">&#34;library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> (</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">) needed or dlopened by </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> &#34;</span>
</span></span><span class="line"><span class="cl">                                  <span class="s">&#34;is not accessible by namespace </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">name</span><span class="p">,</span> <span class="n">realpath</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sopath</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">add_dlwarning</span><span class="p">(</span><span class="n">sopath</span><span class="p">,</span> <span class="s">&#34;unauthorized access to&#34;</span><span class="p">,</span>  <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// do not load libraries if they are not accessible for the specified namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">needed_or_dlopened_by</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">                                          <span class="s">&#34;(unknown)&#34;</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">DL_OPEN_ERR</span><span class="p">(</span><span class="s">&#34;library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> needed or dlopened by </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> is not accessible for the namespace </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">name</span><span class="p">,</span> <span class="n">needed_or_dlopened_by</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// do not print this if a library is in the list of shared libraries for linked namespaces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">maybe_accessible_via_namespace_links</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PRINT</span><span class="p">(</span><span class="s">&#34;library </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> (</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">) needed or dlopened by </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> is not accessible for the&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="s">&#34; namespace: [name=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, ld_library_paths=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, default_library_paths=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">,&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="s">&#34; permitted_paths=</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">name</span><span class="p">,</span> <span class="n">realpath</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">              <span class="n">needed_or_dlopened_by</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">              <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">Join</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_ld_library_paths</span><span class="p">(),</span> <span class="sc">&#39;:&#39;</span><span class="p">).</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">              <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">Join</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_default_library_paths</span><span class="p">(),</span> <span class="sc">&#39;:&#39;</span><span class="p">).</span><span class="n">c_str</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">              <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">Join</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_permitted_paths</span><span class="p">(),</span> <span class="sc">&#39;:&#39;</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="n">soinfo_alloc</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">realpath</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">file_stat</span><span class="p">,</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">rtld_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_soinfo</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Read the ELF header and some of the segments.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">realpath</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">file_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="o">-&gt;</span><span class="n">remove_cached_elf_reader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="o">-&gt;</span><span class="n">set_soinfo</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo_free</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Find and set DT_RUNPATH, DT_SONAME, and DT_FLAGS_1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Note that these field values are temporary and are
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// going to be overwritten on soinfo::prelink_image
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// with values from PT_LOAD segments.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="n">ElfReader</span><span class="o">&amp;</span> <span class="n">elf_reader</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_elf_reader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Dyn</span><span class="p">)</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="n">elf_reader</span><span class="p">.</span><span class="n">dynamic</span><span class="p">();</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">!=</span> <span class="n">DT_NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_RUNPATH</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_dt_runpath</span><span class="p">(</span><span class="n">elf_reader</span><span class="p">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_SONAME</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_soname</span><span class="p">(</span><span class="n">elf_reader</span><span class="p">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We need to identify a DF_1_GLOBAL library early so we can link it to namespaces.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_FLAGS_1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_dt_flags_1</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if !defined(__ANDROID__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">// Bionic on the host currently uses some Android prebuilts, which don&#39;t set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// DT_RUNPATH with any relative paths, so they can&#39;t find their dependencies.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// b/118058804
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">get_dt_runpath</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_dt_runpath</span><span class="p">(</span><span class="s">&#34;$ORIGIN/../lib64:$ORIGIN/lib64&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">for_each_dt_needed</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">get_elf_reader</span><span class="p">(),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_tasks</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">LoadTask</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_readers_map</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="21026-read">
<a class="header-anchor" href="#21026-read"></a>
2.10.2.6. read
</h5><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">off64_t</span> <span class="n">file_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ElfReader</span><span class="o">&amp;</span> <span class="n">elf_reader</span> <span class="o">=</span> <span class="n">get_elf_reader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">elf_reader</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">realpath</span><span class="p">,</span> <span class="n">fd_</span><span class="p">,</span> <span class="n">file_offset_</span><span class="p">,</span> <span class="n">file_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>在获取到待加载的 so 的各个段的结构之后，接下来就是解析 <code>.dynamic</code> 中保存的符号</p>
<h5 id="21027-elfreaderread">
<a class="header-anchor" href="#21027-elfreaderread"></a>
2.10.2.7. ElfReader::Read
</h5><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker_phdr.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">ElfReader</span><span class="o">::</span><span class="n">Read</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">off64_t</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">off64_t</span> <span class="n">file_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">did_read_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">name_</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fd_</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">file_offset_</span> <span class="o">=</span> <span class="n">file_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">file_size_</span> <span class="o">=</span> <span class="n">file_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ReadElfHeader</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="c1">// 从文件中读取 ELF 头部信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">VerifyElfHeader</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="c1">// 验证 ELF 头的有效性，比如检查魔数（magic number）、字节序和架构是否正确。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ReadProgramHeaders</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="c1">// 读取程序头表，描述 ELF 文件的段（segments）。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ReadSectionHeaders</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="c1">// 读取节头表，描述 ELF 文件的节（sections）。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ReadDynamicSection</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// 读取动态节（.dynamic 节），包含动态链接相关的信息。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">did_read_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">did_read_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在获取到待加载的 so 的各个段的结构之后，接下来就是解析 <code>.dynamic</code> 中保存的符号</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// Find and set DT_RUNPATH, DT_SONAME, and DT_FLAGS_1.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note that these field values are temporary and are
</span></span></span><span class="line"><span class="cl"><span class="c1">// going to be overwritten on soinfo::prelink_image
</span></span></span><span class="line"><span class="cl"><span class="c1">// with values from PT_LOAD segments.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="n">ElfReader</span><span class="o">&amp;</span> <span class="n">elf_reader</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_elf_reader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Dyn</span><span class="p">)</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="n">elf_reader</span><span class="p">.</span><span class="n">dynamic</span><span class="p">();</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">!=</span> <span class="n">DT_NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_RUNPATH</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_dt_runpath</span><span class="p">(</span><span class="n">elf_reader</span><span class="p">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_SONAME</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_soname</span><span class="p">(</span><span class="n">elf_reader</span><span class="p">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We need to identify a DF_1_GLOBAL library early so we can link it to namespaces.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_FLAGS_1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_dt_flags_1</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>之后找到待加载的 so 的依赖库，这里有一个模板函数 <code>for_each_dt_needed</code> , 找到 <code>.dynamic</code> 中所有带有 <code>DT_NEEDED</code> 标志的字符串，这些字符串的名称就是这个 so 所需要的依赖库，然后将它们添加到 <code>load_tasks</code> 队列中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">for_each_dt_needed</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">get_elf_reader</span><span class="p">(),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span> <span class="s">&#34;load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">load_tasks</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">LoadTask</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_readers_map</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//android-platform\bionic\linker\linker_soinfo.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">for_each_dt_needed</span><span class="p">(</span><span class="k">const</span> <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="n">F</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Dyn</span><span class="p">)</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">!=</span> <span class="n">DT_NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_NEEDED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">action</span><span class="p">(</span><span class="n">fix_dt_needed</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">get_string</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">),</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="2103-step-2-加载库">
<a class="header-anchor" href="#2103-step-2-%e5%8a%a0%e8%bd%bd%e5%ba%93"></a>
2.10.3. Step 2: 加载库
</h4><p>将所有未链接的库加载到内存中。遍历 <code>load_list</code>，调用 <code>task-&gt;load</code> 将库加载到内存。这一步完成库的实际加载，将 ELF 文件映射到进程的地址空间。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// Step 2: Load libraries in random order (see b/24047022)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">LoadTaskList</span> <span class="n">load_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="nl">task</span> <span class="p">:</span> <span class="n">load_tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_soinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">pred</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">LoadTask</span><span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">get_soinfo</span><span class="p">()</span> <span class="o">==</span> <span class="n">si</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">is_linked</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">load_list</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">load_list</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="n">load_list</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">load_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">reserved_address_recursive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">reserved_address_recursive</span> <span class="o">=</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_RESERVED_ADDRESS_RECURSIVE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reserved_address_recursive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Shuffle the load order in the normal case, but not if we are loading all
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the libraries to a reserved address range.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">shuffle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">load_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Set up address space parameters.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">address_space_params</span> <span class="n">extinfo_params</span><span class="p">,</span> <span class="n">default_params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">relro_fd_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_RESERVED_ADDRESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">extinfo_params</span><span class="p">.</span><span class="n">start_addr</span> <span class="o">=</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">reserved_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">extinfo_params</span><span class="p">.</span><span class="n">reserved_size</span> <span class="o">=</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">reserved_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">extinfo_params</span><span class="p">.</span><span class="n">must_use_address</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_RESERVED_ADDRESS_HINT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">extinfo_params</span><span class="p">.</span><span class="n">start_addr</span> <span class="o">=</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">reserved_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">extinfo_params</span><span class="p">.</span><span class="n">reserved_size</span> <span class="o">=</span> <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">reserved_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="nl">task</span> <span class="p">:</span> <span class="n">load_list</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">address_space_params</span><span class="o">*</span> <span class="n">address_space</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">reserved_address_recursive</span> <span class="o">||</span> <span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">is_dt_needed</span><span class="p">())</span> <span class="o">?</span> <span class="o">&amp;</span><span class="nl">extinfo_params</span> <span class="p">:</span> <span class="o">&amp;</span><span class="n">default_params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">address_space</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">load</span><span class="p">(</span><span class="n">address_space_params</span><span class="o">*</span> <span class="n">address_space</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ElfReader</span><span class="o">&amp;</span> <span class="n">elf_reader</span> <span class="o">=</span> <span class="n">get_elf_reader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elf_reader</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">address_space</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">si_</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">elf_reader</span><span class="p">.</span><span class="n">load_start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">si_</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">elf_reader</span><span class="p">.</span><span class="n">load_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">si_</span><span class="o">-&gt;</span><span class="n">set_mapped_by_caller</span><span class="p">(</span><span class="n">elf_reader</span><span class="p">.</span><span class="n">is_mapped_by_caller</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">si_</span><span class="o">-&gt;</span><span class="n">load_bias</span> <span class="o">=</span> <span class="n">elf_reader</span><span class="p">.</span><span class="n">load_bias</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">si_</span><span class="o">-&gt;</span><span class="n">phnum</span> <span class="o">=</span> <span class="n">elf_reader</span><span class="p">.</span><span class="n">phdr_count</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">si_</span><span class="o">-&gt;</span><span class="n">phdr</span> <span class="o">=</span> <span class="n">elf_reader</span><span class="p">.</span><span class="n">loaded_phdr</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">si_</span><span class="o">-&gt;</span><span class="n">set_gap_start</span><span class="p">(</span><span class="n">elf_reader</span><span class="p">.</span><span class="n">gap_start</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">si_</span><span class="o">-&gt;</span><span class="n">set_gap_size</span><span class="p">(</span><span class="n">elf_reader</span><span class="p">.</span><span class="n">gap_size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><ul>
<li><code>ElfReader::Load()</code>调用<code>LoadSegments()</code>，<code>LoadSegments()</code>中调用<code>mmap</code>将so文件的<code>PT_LOAD</code>段都map到加载基地址<code>load_bias_</code>中</li>
<li><code>ElfReader::Load()</code>调用<code>phdr_table_protect_segments()</code>，<code>phdr_table_protect_segments()</code>中调用mprotect修改各个PT_LOAD程序段的内存属性</li>
</ul>
<h4 id="2104-step-3-预链接依赖库">
<a class="header-anchor" href="#2104-step-3-%e9%a2%84%e9%93%be%e6%8e%a5%e4%be%9d%e8%b5%96%e5%ba%93"></a>
2.10.4. Step 3: 预链接依赖库
</h4><p>对所有未链接的库进行预链接（解析 ELF 文件头和程序段），调用 <code>prelink_image</code> 解析库的程序头（<code>phdr</code>）和其他元数据。确保库的内存布局正确，为后续符号链接做准备。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Step 3: pre-link all DT_NEEDED libraries in breadth first order.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="nl">task</span> <span class="p">:</span> <span class="n">load_tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_soinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">is_linked</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">prelink_image</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">register_soinfo_tls</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="2105-step-4-构建全局组">
<a class="header-anchor" href="#2105-step-4-%e6%9e%84%e5%bb%ba%e5%85%a8%e5%b1%80%e7%bb%84"></a>
2.10.5. Step 4: 构建全局组
</h4><p>为所有预加载库设置 <code>DF_1_GLOBAL</code> 标志，确保它们对所有命名空间可见。保证预加载库（如 <code>LD_PRELOAD</code>）在全局范围内可用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Step 4: Construct the global group. DF_1_GLOBAL bit is force set for LD_PRELOADed libs because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// they must be added to the global group. Note: The DF_1_GLOBAL bit for a library is normally set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// in step 3.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">ld_preloads</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="nl">si</span> <span class="p">:</span> <span class="o">*</span><span class="n">ld_preloads</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_dt_flags_1</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">get_dt_flags_1</span><span class="p">()</span> <span class="o">|</span> <span class="n">DF_1_GLOBAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>这里我们看到调用了 <code>prelink_image</code> 来预链接依赖库，主要是遍历 <code>.dynamic</code> 节，来提取必要的信息例如 <code>strtab_</code> , <code>symtab_</code> , <code>plt_rela_</code> , <code>init_array_</code> 等等各种必要的信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">soinfo</span><span class="o">::</span><span class="n">prelink_image</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">flags_</span> <span class="o">&amp;</span> <span class="n">FLAG_PRELINKED</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Extract dynamic section */</span>
</span></span><span class="line"><span class="cl">  <span class="n">ElfW</span><span class="p">(</span><span class="n">Word</span><span class="p">)</span> <span class="n">dynamic_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">phdr_table_get_dynamic_section</span><span class="p">(</span><span class="n">phdr</span><span class="p">,</span> <span class="n">phnum</span><span class="p">,</span> <span class="n">load_bias</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dynamic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dynamic_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* We can&#39;t log anything until the linker is relocated */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">relocating_linker</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags_</span> <span class="o">&amp;</span> <span class="n">FLAG_LINKER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocating_linker</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">INFO</span><span class="p">(</span><span class="s">&#34;[ Linking </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> ]&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;si-&gt;base = %p si-&gt;flags = 0x%08x&#34;</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="n">flags_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">dynamic</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocating_linker</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;missing PT_DYNAMIC in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocating_linker</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;dynamic = %p&#34;</span><span class="p">,</span> <span class="n">dynamic</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(__arm__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">phdr_table_get_arm_exidx</span><span class="p">(</span><span class="n">phdr</span><span class="p">,</span> <span class="n">phnum</span><span class="p">,</span> <span class="n">load_bias</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">&amp;</span><span class="n">ARM_exidx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ARM_exidx_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">TlsSegment</span> <span class="n">tls_segment</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">__bionic_get_tls_segment</span><span class="p">(</span><span class="n">phdr</span><span class="p">,</span> <span class="n">phnum</span><span class="p">,</span> <span class="n">load_bias</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tls_segment</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__bionic_check_tls_alignment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tls_segment</span><span class="p">.</span><span class="n">alignment</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocating_linker</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;TLS segment alignment in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> is not a power of 2: %zu&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">get_realpath</span><span class="p">(),</span> <span class="n">tls_segment</span><span class="p">.</span><span class="n">alignment</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">tls_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">soinfo_tls</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">tls_</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">tls_segment</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Extract useful information from dynamic section.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Note that: &#34;Except for the DT_NULL element at the end of the array,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// and the relative order of DT_NEEDED elements, entries may appear in any order.&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// source: http://www.sco.com/developers/gabi/1998-04-29/ch5.dynamic.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">needed_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Dyn</span><span class="p">)</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="n">dynamic</span><span class="p">;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">!=</span> <span class="n">DT_NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;d = %p, d[0](tag) = %p d[1](val) = %p&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">d</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span><span class="p">),</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_SONAME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// this is parsed after we have strtab initialized (see below).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 哈希表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_HASH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">nbucket_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">nchain_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">bucket_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">chain_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">nbucket_</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_GNU_HASH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">gnu_nbucket_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// skip symndx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">gnu_maskwords_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">)[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">gnu_shift2_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">gnu_bloom_filter_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">gnu_bucket_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">gnu_bloom_filter_</span> <span class="o">+</span> <span class="n">gnu_maskwords_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// amend chain for symndx = header[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">gnu_chain_</span> <span class="o">=</span> <span class="n">gnu_bucket_</span> <span class="o">+</span> <span class="n">gnu_nbucket_</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">            <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">powerof2</span><span class="p">(</span><span class="n">gnu_maskwords_</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;invalid maskwords for gnu_hash = 0x%x, in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> expecting power to two&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">gnu_maskwords_</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">--</span><span class="n">gnu_maskwords_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">flags_</span> <span class="o">|=</span> <span class="n">FLAG_GNU_HASH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 字符串表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_STRTAB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">strtab_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 字符串表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_STRSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">strtab_size_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 符号表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_SYMTAB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">symtab_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Sym</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_SYMENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Sym</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;invalid DT_SYMENT: %zd in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">),</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// PLT 重定位使用的重定位条目类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_PLTREL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(USE_RELA)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">!=</span> <span class="n">DT_RELA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_PLTREL in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">; expected DT_RELA&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">!=</span> <span class="n">DT_REL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_PLTREL in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">; expected DT_REL&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// PLT 重定位表在内存中的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_JMPREL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(USE_RELA)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="n">plt_rela_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rela</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="n">plt_rel_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rel</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//  PLT 重定位表大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_PLTRELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(USE_RELA)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="n">plt_rela_count_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rela</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="n">plt_rel_count_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rel</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// PLT 和/或 GOT 在内存中的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_PLTGOT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Ignored (because RTLD_LAZY is not supported).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Set the DT_DEBUG entry to the address of _r_debug for GDB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// if the dynamic table is writable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">((</span><span class="n">dynamic_flags</span> <span class="o">&amp;</span> <span class="n">PF_W</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_r_debug</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(USE_RELA)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="k">case</span> <span class="nl">DT_RELA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">rela_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rela</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELASZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">rela_count_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rela</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">android_relocs_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELASZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">android_relocs_size_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_REL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_ANDROID_REL in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_ANDROID_RELSZ in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELAENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rela</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;invalid DT_RELAENT: %zd&#34;</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Ignored (see DT_RELCOUNT comments for details).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_RELACOUNT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_REL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_REL in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_RELSZ in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="k">case</span> <span class="nl">DT_REL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">rel_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rel</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">rel_count_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rel</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Rel</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;invalid DT_RELENT: %zd&#34;</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_REL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">android_relocs_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">android_relocs_size_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_ANDROID_RELA in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELASZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_ANDROID_RELASZ in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// &#34;Indicates that all RELATIVE relocations have been concatenated together,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// and specifies the RELATIVE relocation count.&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// TODO: Spec also mentions that this can be used to optimize relocation process;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Not currently used by bionic linker - ignored.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_RELCOUNT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_RELA in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELASZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;unsupported DT_RELASZ in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="k">case</span> <span class="nl">DT_RELR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">relr_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Relr</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELRSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELRSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">relr_count_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Relr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RELRENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_ANDROID_RELRENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Relr</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;invalid DT_RELRENT: %zd&#34;</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Ignored (see DT_RELCOUNT comments for details).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// There is no DT_RELRCOUNT specifically because it would only be ignored.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_ANDROID_RELRCOUNT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 初始化函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_INIT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">init_func_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">linker_ctor_function_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;%s constructors (DT_INIT) found at %p&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">(),</span> <span class="n">init_func_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 析构函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_FINI</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fini_func_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">linker_dtor_function_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;%s destructors (DT_FINI) found at %p&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">(),</span> <span class="n">fini_func_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// .init_array 初始化函数列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_INIT_ARRAY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">init_array_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">linker_ctor_function_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;%s constructors (DT_INIT_ARRAY) found at %p&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">(),</span> <span class="n">init_array_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// .init_array 大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_INIT_ARRAYSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">init_array_count_</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// .fini_array 析构函数列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_FINI_ARRAY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fini_array_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">linker_dtor_function_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;%s destructors (DT_FINI_ARRAY) found at %p&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">(),</span> <span class="n">fini_array_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// .fini_array 大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_FINI_ARRAYSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fini_array_count_</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//初始化函数,大多只出现在可执行文件中,在so中忽略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// 在bionic/linker/linker_soinfo.cpp中有明确注释
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// DT_PREINIT_ARRAY functions are called before any other constructors for executables,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// but ignored in a shared library.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_PREINIT_ARRAY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">preinit_array_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">linker_ctor_function_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;%s constructors (DT_PREINIT_ARRAY) found at %p&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">(),</span> <span class="n">preinit_array_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_PREINIT_ARRAYSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">preinit_array_count_</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_TEXTREL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(__LP64__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has text relocations&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="n">has_text_relocations</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_SYMBOLIC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">has_DT_SYMBOLIC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//当前so的依赖，仅做计数操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_NEEDED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="o">++</span><span class="n">needed_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_FLAGS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">&amp;</span> <span class="n">DF_TEXTREL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(__LP64__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>          <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has text relocations&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>          <span class="n">has_text_relocations</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">&amp;</span> <span class="n">DF_SYMBOLIC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">has_DT_SYMBOLIC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_FLAGS_1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">set_dt_flags_1</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SUPPORTED_DT_FLAGS_1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_WARN</span><span class="p">(</span><span class="s">&#34;Warning: </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has unsupported flags DT_FLAGS_1=%p &#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="s">&#34;(ignoring unsupported flags)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">get_realpath</span><span class="p">(),</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Ignored: &#34;Its use has been superseded by the DF_BIND_NOW flag&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="nl">DT_BIND_NOW</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_VERSYM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">versym_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Versym</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_VERDEF</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">verdef_ptr_</span> <span class="o">=</span> <span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_VERDEFNUM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">verdef_cnt_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_VERNEED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">verneed_ptr_</span> <span class="o">=</span> <span class="n">load_bias</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_VERNEEDNUM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">verneed_cnt_</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_RUNPATH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// this is parsed after we have strtab initialized (see below).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_TLSDESC_GOT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_TLSDESC_PLT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// These DT entries are used for lazy TLSDESC relocations. Bionic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// resolves everything eagerly, so these can be ignored.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(__aarch64__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="k">case</span> <span class="nl">DT_AARCH64_BTI_PLT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_AARCH64_PAC_PLT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nl">DT_AARCH64_VARIANT_PCS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Ignored: AArch64 processor-specific dynamic array tags.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocating_linker</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">tag_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_RPATH</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tag_name</span> <span class="o">=</span> <span class="s">&#34;DT_RPATH&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">==</span> <span class="n">DT_ENCODING</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tag_name</span> <span class="o">=</span> <span class="s">&#34;DT_ENCODING&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">&gt;=</span> <span class="n">DT_LOOS</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">&lt;=</span> <span class="n">DT_HIOS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tag_name</span> <span class="o">=</span> <span class="s">&#34;unknown OS-specific&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">&gt;=</span> <span class="n">DT_LOPROC</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">&lt;=</span> <span class="n">DT_HIPROC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tag_name</span> <span class="o">=</span> <span class="s">&#34;unknown processor-specific&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tag_name</span> <span class="o">=</span> <span class="s">&#34;unknown&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">DL_WARN</span><span class="p">(</span><span class="s">&#34;Warning: </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> unused DT entry: %s (type %p arg %p) (ignoring)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">get_realpath</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                  <span class="n">tag_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                  <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;si-&gt;base = %p, si-&gt;strtab = %p, si-&gt;symtab = %p&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="n">strtab_</span><span class="p">,</span> <span class="n">symtab_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Validity checks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">relocating_linker</span> <span class="o">&amp;&amp;</span> <span class="n">needed_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;linker cannot have DT_NEEDED dependencies on other libraries&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">nbucket_</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">gnu_nbucket_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;empty/missing DT_HASH/DT_GNU_HASH in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> &#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;(new hash type from the future?)&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">strtab_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;empty/missing DT_STRTAB in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">symtab_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;empty/missing DT_SYMTAB in </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Second pass - parse entries relying on strtab. Skip this while relocating the linker so as to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// avoid doing heap allocations until later in the linker&#39;s initialization.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocating_linker</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Dyn</span><span class="p">)</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="n">dynamic</span><span class="p">;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span> <span class="o">!=</span> <span class="n">DT_NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">switch</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_tag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_SONAME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">set_soname</span><span class="p">(</span><span class="n">get_string</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DT_RUNPATH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">set_dt_runpath</span><span class="p">(</span><span class="n">get_string</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="p">.</span><span class="n">d_val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Before M release, linker was using basename in place of soname. In the case when DT_SONAME is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// absent some apps stop working because they can&#39;t find DT_NEEDED library by soname. This
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// workaround should keep them working. (Applies only for apps targeting sdk version &lt; M.) Make
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// an exception for the main executable, which does not need to have DT_SONAME. The linker has an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// DT_SONAME but the soname_ field is initialized later on.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">soname_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span> <span class="o">!=</span> <span class="n">solist_get_somain</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">relocating_linker</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="n">get_application_target_sdk_version</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">soname_</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">realpath_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">DL_WARN_documented_change</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s">&#34;missing-soname-enforced-for-api-level-23&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has no DT_SONAME (will use %s instead)&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                              <span class="n">soname_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Don&#39;t call add_dlwarning because a missing DT_SONAME isn&#39;t important enough to show in the UI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Validate each library&#39;s verdef section once, so we don&#39;t have to validate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// it each time we look up a symbol with a version.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">validate_verdef_section</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">flags_</span> <span class="o">|=</span> <span class="n">FLAG_PRELINKED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="2106-step-5-收集局部组根">
<a class="header-anchor" href="#2106-step-5-%e6%94%b6%e9%9b%86%e5%b1%80%e9%83%a8%e7%bb%84%e6%a0%b9"></a>
2.10.6. Step 5: 收集局部组根
</h4><p>收集局部组的根库（跨越命名空间边界的库），为后续链接局部组准备根节点。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// Step 5: Collect roots of local_groups.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Whenever needed_by-&gt;si link crosses a namespace boundary it forms its own local_group.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Here we collect new roots to link them separately later on. Note that we need to avoid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// collecting duplicates. Also the order is important. They need to be linked in the same
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// BFS order we link individual libraries.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">soinfo</span><span class="o">*&gt;</span> <span class="n">local_group_roots</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">start_with</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">add_as_children</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_group_roots</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">start_with</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="n">soinfos_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_group_roots</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">soinfos</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="nl">task</span> <span class="p">:</span> <span class="n">load_tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_soinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">needed_by</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">is_dt_needed</span> <span class="o">=</span> <span class="n">needed_by</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">needed_by</span> <span class="o">!=</span> <span class="n">start_with</span> <span class="o">||</span> <span class="n">add_as_children</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">needed_by_ns</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">is_dt_needed</span> <span class="o">?</span> <span class="n">needed_by</span><span class="o">-&gt;</span><span class="n">get_primary_namespace</span><span class="p">()</span> <span class="o">:</span> <span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">is_linked</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_primary_namespace</span><span class="p">()</span> <span class="o">!=</span> <span class="n">needed_by_ns</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">local_group_roots</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">local_group_roots</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">LD_LOG</span><span class="p">(</span><span class="n">kLogDlopen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="s">&#34;Crossing namespace boundary (si=%s@%p, si_ns=%s@%p, needed_by=%s@%p, ns=%s@%p, needed_by_ns=%s@%p) adding to local_group_roots: %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">             <span class="n">si</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_primary_namespace</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">             <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_primary_namespace</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">             <span class="n">needed_by</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="s">&#34;(nullptr)&#34;</span> <span class="o">:</span> <span class="n">needed_by</span><span class="o">-&gt;</span><span class="n">get_realpath</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">             <span class="n">needed_by</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">             <span class="n">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">needed_by_ns</span><span class="o">-&gt;</span><span class="n">get_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">             <span class="n">needed_by_ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">it</span> <span class="o">==</span> <span class="n">local_group_roots</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;yes&#34;</span> <span class="o">:</span> <span class="s">&#34;no&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">local_group_roots</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_group_roots</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h4 id="2107-step-6-链接所有局部组">
<a class="header-anchor" href="#2107-step-6-%e9%93%be%e6%8e%a5%e6%89%80%e6%9c%89%e5%b1%80%e9%83%a8%e7%bb%84"></a>
2.10.7. Step 6: 链接所有局部组
</h4><p>链接每个局部组中的库，完成符号解析和重定位。完成库的动态链接，使其可用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// Step 6: Link all local groups
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">root</span> <span class="p">:</span> <span class="n">local_group_roots</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo_list_t</span> <span class="n">local_group</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">android_namespace_t</span><span class="o">*</span> <span class="n">local_group_ns</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">get_primary_namespace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">walk_dependencies_tree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">local_group_ns</span><span class="o">-&gt;</span><span class="n">is_accessible</span><span class="p">(</span><span class="n">si</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">local_group</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">kWalkContinue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">kWalkSkip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">soinfo_list_t</span> <span class="n">global_group</span> <span class="o">=</span> <span class="n">local_group_ns</span><span class="o">-&gt;</span><span class="n">get_global_group</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SymbolLookupList</span> <span class="nf">lookup_list</span><span class="p">(</span><span class="n">global_group</span><span class="p">,</span> <span class="n">local_group</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">local_group_root</span> <span class="o">=</span> <span class="n">local_group</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">linked</span> <span class="o">=</span> <span class="n">local_group</span><span class="p">.</span><span class="n">visit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Even though local group may contain accessible soinfos from other namespaces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// we should avoid linking them (because if they are not linked -&gt; they
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// are in the local_group_roots and will be linked later).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">is_linked</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_primary_namespace</span><span class="p">()</span> <span class="o">==</span> <span class="n">local_group_ns</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">link_extinfo</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">si</span> <span class="o">==</span> <span class="n">soinfos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">reserved_address_recursive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Only forward extinfo for the first library unless the recursive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// flag is set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">link_extinfo</span> <span class="o">=</span> <span class="n">extinfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">__libc_shared_globals</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">load_hook</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">__libc_shared_globals</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">load_hook</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">load_bias</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">phdr</span><span class="p">,</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">phnum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">lookup_list</span><span class="p">.</span><span class="n">set_dt_symbolic_lib</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">has_DT_SYMBOLIC</span> <span class="o">?</span> <span class="nl">si</span> <span class="p">:</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">link_image</span><span class="p">(</span><span class="n">lookup_list</span><span class="p">,</span> <span class="n">local_group_root</span><span class="p">,</span> <span class="n">link_extinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">relro_fd_offset</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="o">!</span><span class="n">get_cfi_shadow</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AfterLoad</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">solist_get_head</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">linked</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>当把所有的本地组和全局组加入到 <code>lookup_list</code> 中后，就开始调用 <code>si-&gt;link_image</code> 来对这些库进行链接的操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">soinfo</span><span class="o">::</span><span class="nf">link_image</span><span class="p">(</span><span class="k">const</span> <span class="n">SymbolLookupList</span><span class="o">&amp;</span> <span class="n">lookup_list</span><span class="p">,</span> <span class="n">soinfo</span><span class="o">*</span> <span class="n">local_group_root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">const</span> <span class="n">android_dlextinfo</span><span class="o">*</span> <span class="n">extinfo</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">*</span> <span class="n">relro_fd_offset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">is_image_linked</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// already linked.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">g_is_ldd</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">is_main_executable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">async_safe_format_fd</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\t</span><span class="s">%s =&gt; %s (%p)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">get_soname</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                         <span class="nf">get_realpath</span><span class="p">(),</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">local_group_root_</span> <span class="o">=</span> <span class="n">local_group_root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_group_root_</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_group_root_</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">flags_</span> <span class="o">&amp;</span> <span class="n">FLAG_LINKER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">local_group_root_</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_sdk_version_</span> <span class="o">=</span> <span class="nf">get_application_target_sdk_version</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if !defined(__LP64__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">has_text_relocations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Fail if app is targeting M or above.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">app_target_api_level</span> <span class="o">=</span> <span class="nf">get_application_target_sdk_version</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">app_target_api_level</span> <span class="o">&gt;=</span> <span class="mi">23</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DL_ERR_AND_LOG</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has text relocations (%s#Text-Relocations-Enforced-for-API-level-23)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="nf">get_realpath</span><span class="p">(),</span> <span class="n">kBionicChangesUrl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Make segments writable to allow text relocations to work properly. We will later call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// phdr_table_protect_segments() after all of them are applied.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">DL_WARN_documented_change</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="s">&#34;Text-Relocations-Enforced-for-API-level-23&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has text relocations&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="nf">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nf">add_dlwarning</span><span class="p">(</span><span class="nf">get_realpath</span><span class="p">(),</span> <span class="s">&#34;text relocations&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">phdr_table_unprotect_segments</span><span class="p">(</span><span class="n">phdr</span><span class="p">,</span> <span class="n">phnum</span><span class="p">,</span> <span class="n">load_bias</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DL_ERR</span><span class="p">(</span><span class="s">&#34;can&#39;t unprotect loadable segments for </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: %s&#34;</span><span class="p">,</span> <span class="nf">get_realpath</span><span class="p">(),</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">relocate</span><span class="p">(</span><span class="n">lookup_list</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">DEBUG</span><span class="p">(</span><span class="s">&#34;[ finished linking %s ]&#34;</span><span class="p">,</span> <span class="nf">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if !defined(__LP64__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">has_text_relocations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// All relocations are done, we can protect our segments back to read-only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">phdr_table_protect_segments</span><span class="p">(</span><span class="n">phdr</span><span class="p">,</span> <span class="n">phnum</span><span class="p">,</span> <span class="n">load_bias</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DL_ERR</span><span class="p">(</span><span class="s">&#34;can&#39;t protect segments for </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nf">get_realpath</span><span class="p">(),</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// We can also turn on GNU RELRO protection if we&#39;re not linking the dynamic linker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// itself --- it can&#39;t make system calls yet, and will have to call protect_relro later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">is_linker</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">protect_relro</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Handle serializing/sharing the RELRO segment */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_WRITE_RELRO</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">phdr_table_serialize_gnu_relro</span><span class="p">(</span><span class="n">phdr</span><span class="p">,</span> <span class="n">phnum</span><span class="p">,</span> <span class="n">load_bias</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">relro_fd</span><span class="p">,</span> <span class="n">relro_fd_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DL_ERR</span><span class="p">(</span><span class="s">&#34;failed serializing GNU RELRO section for </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nf">get_realpath</span><span class="p">(),</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">extinfo</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANDROID_DLEXT_USE_RELRO</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">phdr_table_map_gnu_relro</span><span class="p">(</span><span class="n">phdr</span><span class="p">,</span> <span class="n">phnum</span><span class="p">,</span> <span class="n">load_bias</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">extinfo</span><span class="o">-&gt;</span><span class="n">relro_fd</span><span class="p">,</span> <span class="n">relro_fd_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DL_ERR</span><span class="p">(</span><span class="s">&#34;failed mapping GNU RELRO section for </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">: %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nf">get_realpath</span><span class="p">(),</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">g_module_load_counter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">notify_gdb_of_load</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">set_image_linked</span><span class="p">();</span><span class="n">frelocate</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在 <code>soinfo::link_image</code> 中调用了 <code>relocate</code> 去进行符号的重定位</p>
<ul>
<li>使用显示加数的和未使用显示加数的分类处理</li>
<li>调用两次<code>plain_relocate()</code>，分别对<code>.rel.dyn</code>和<code>.rel.plt</code>节区中的重定位信息进行重定位</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker_relocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">soinfo</span><span class="o">::</span><span class="n">relocate</span><span class="p">(</span><span class="k">const</span> <span class="n">SymbolLookupList</span><span class="o">&amp;</span> <span class="n">lookup_list</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">VersionTracker</span> <span class="n">version_tracker</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">version_tracker</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Relocator</span> <span class="nf">relocator</span><span class="p">(</span><span class="n">version_tracker</span><span class="p">,</span> <span class="n">lookup_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">relocator</span><span class="p">.</span><span class="n">si</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">relocator</span><span class="p">.</span><span class="n">si_strtab</span> <span class="o">=</span> <span class="n">strtab_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">relocator</span><span class="p">.</span><span class="n">si_strtab_size</span> <span class="o">=</span> <span class="n">has_min_version</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nl">strtab_size_</span> <span class="p">:</span> <span class="n">SIZE_MAX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">relocator</span><span class="p">.</span><span class="n">si_symtab</span> <span class="o">=</span> <span class="n">symtab_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">relocator</span><span class="p">.</span><span class="n">tlsdesc_args</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tlsdesc_args_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">relocator</span><span class="p">.</span><span class="n">tls_tp_base</span> <span class="o">=</span> <span class="n">__libc_shared_globals</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">static_tls_layout</span><span class="p">.</span><span class="n">offset_thread_pointer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">android_relocs_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// check signature
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">android_relocs_size_</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">android_relocs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">android_relocs_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">android_relocs_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">android_relocs_</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;[ android relocating %s ]&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">packed_relocs</span> <span class="o">=</span> <span class="n">android_relocs_</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">size_t</span> <span class="n">packed_relocs_size</span> <span class="o">=</span> <span class="n">android_relocs_size_</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packed_relocate</span><span class="o">&lt;</span><span class="n">RelocMode</span><span class="o">::</span><span class="n">Typical</span><span class="o">&gt;</span><span class="p">(</span><span class="n">relocator</span><span class="p">,</span> <span class="n">sleb128_decoder</span><span class="p">(</span><span class="n">packed_relocs</span><span class="p">,</span> <span class="n">packed_relocs_size</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">DL_ERR</span><span class="p">(</span><span class="s">&#34;bad android relocation header.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">relr_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;[ relocating %s relr ]&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relocate_relr</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(USE_RELA)    </span><span class="c1">//如果使用了显式加数（一般64位使用）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">rela_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;[ relocating %s rela ]&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plain_relocate</span><span class="o">&lt;</span><span class="n">RelocMode</span><span class="o">::</span><span class="n">Typical</span><span class="o">&gt;</span><span class="p">(</span><span class="n">relocator</span><span class="p">,</span> <span class="n">rela_</span><span class="p">,</span> <span class="n">rela_count_</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">plt_rela_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;[ relocating %s plt rela ]&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plain_relocate</span><span class="o">&lt;</span><span class="n">RelocMode</span><span class="o">::</span><span class="n">JumpTable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">relocator</span><span class="p">,</span> <span class="n">plt_rela_</span><span class="p">,</span> <span class="n">plt_rela_count_</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else    </span><span class="c1">//如果没有使用显式加数（一般32位使用）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">rel_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//.rel.dyn节区中的重定位信息进行重定位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;[ relocating %s rel ]&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plain_relocate</span><span class="o">&lt;</span><span class="n">RelocMode</span><span class="o">::</span><span class="n">Typical</span><span class="o">&gt;</span><span class="p">(</span><span class="n">relocator</span><span class="p">,</span> <span class="n">rel_</span><span class="p">,</span> <span class="n">rel_count_</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">plt_rel_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//.rel.plt节区中的重定位信息进行重定位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;[ relocating %s plt rel ]&#34;</span><span class="p">,</span> <span class="n">get_realpath</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plain_relocate</span><span class="o">&lt;</span><span class="n">RelocMode</span><span class="o">::</span><span class="n">JumpTable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">relocator</span><span class="p">,</span> <span class="n">plt_rel_</span><span class="p">,</span> <span class="n">plt_rel_count_</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Once the tlsdesc_args_ vector&#39;s size is finalized, we can write the addresses of its elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// into the TLSDESC relocations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if defined(__aarch64__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">// Bionic currently only implements TLSDESC for arm64.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">TlsDescriptor</span><span class="o">*</span><span class="p">,</span> <span class="n">size_t</span><span class="o">&gt;&amp;</span> <span class="nl">pair</span> <span class="p">:</span> <span class="n">relocator</span><span class="p">.</span><span class="n">deferred_tlsdesc_relocs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TlsDescriptor</span><span class="o">*</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">tlsdesc_resolver_dynamic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tlsdesc_args_</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>plain_relocate()</code>-&gt;<code>plain_relocate_impl()</code>-&gt;<code>process_relocation()</code>-&gt;<code>process_relocation_impl()</code></p>
<ul>
<li><code>process_relocation_impl</code>最终会对<code>.rel.plt</code>和<code>.rel.dyn</code>节区中指向的重定位数据进行修正</li>
<li>对于<code>R_GENERIC_JUMP_SLOT</code>，<code>R_GENERIC_GLOB_DAT</code>和<code>R_GENRIC_ABCOLUTE</code>类型的重定位数据只需找到其重定位数据对应的符号并获取到实际内存地址，然后写回修正即可</li>
<li>对于<code>R_GENERIC_RELATIVE</code>类型的重定位数据需要获取其原来相对与0基地址的值，加上实际的内存加载基地址，然后写回修正即可</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker_relocate.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">bool</span> <span class="nf">process_relocation_impl</span><span class="p">(</span><span class="n">Relocator</span><span class="o">&amp;</span> <span class="n">relocator</span><span class="p">,</span> <span class="k">const</span> <span class="n">rel_t</span><span class="o">&amp;</span> <span class="n">reloc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">IsGeneral</span> <span class="o">=</span> <span class="n">Mode</span> <span class="o">==</span> <span class="n">RelocMode</span><span class="o">::</span><span class="n">General</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//relocator.si-&gt;load_bias为模块实际的加载基地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//rel_target为对应的待重定位数据的实际内存地址（.got表项的地址）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span><span class="o">*</span> <span class="k">const</span> <span class="n">rel_target</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">reloc</span><span class="p">.</span><span class="n">r_offset</span> <span class="o">+</span> <span class="n">relocator</span><span class="p">.</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">load_bias</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//r_type为重定位类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">r_type</span> <span class="o">=</span> <span class="n">ELFW</span><span class="p">(</span><span class="n">R_TYPE</span><span class="p">)(</span><span class="n">reloc</span><span class="p">.</span><span class="n">r_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//r_sym为对应重定位数据的符号表索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">r_sym</span> <span class="o">=</span> <span class="n">ELFW</span><span class="p">(</span><span class="n">R_SYM</span><span class="p">)(</span><span class="n">reloc</span><span class="p">.</span><span class="n">r_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//利用r_sym符号表索引从.symtab中获取对应的表项，并利用表项的st_name字段在.dynstr中找到对应的重定位符号字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">r_sym</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sym_name</span> <span class="o">=</span> <span class="n">relocator</span><span class="p">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">relocator</span><span class="p">.</span><span class="n">si_symtab</span><span class="p">[</span><span class="n">r_sym</span><span class="p">].</span><span class="n">st_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="cp">#if defined(USE_RELA)      </span><span class="c1">//如果使用了显式加数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">get_addend_rel</span>   <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">reloc</span><span class="p">.</span><span class="n">r_addend</span><span class="p">;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">get_addend_norel</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">reloc</span><span class="p">.</span><span class="n">r_addend</span><span class="p">;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="cp">#else                      </span><span class="c1">//如果没使用显示加数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">get_addend_rel</span>   <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">rel_target</span><span class="p">);</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">get_addend_norel</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">//symaddr = 对应符号实际在内存中的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//一下解析以没有使用显式加数的为例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="k">constexpr</span> <span class="p">(</span><span class="n">IsGeneral</span> <span class="o">||</span> <span class="n">Mode</span> <span class="o">==</span> <span class="n">RelocMode</span><span class="o">::</span><span class="n">JumpTable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//R_GENERIC_JUMP_SLOT是函数引用的重定位类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">r_type</span> <span class="o">==</span> <span class="n">R_GENERIC_JUMP_SLOT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">count_relocation_if</span><span class="o">&lt;</span><span class="n">IsGeneral</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kRelocAbsolute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sym_addr</span> <span class="o">+</span> <span class="n">get_addend_norel</span><span class="p">();</span>  <span class="c1">//get_addend_norel()返回0，result = symaddr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">trace_reloc</span><span class="p">(</span><span class="s">&#34;RELO JMP_SLOT %16p &lt;- %16p %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">rel_target</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">sym_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">rel_target</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>           <span class="c1">//需要重定位的数据修正为sym_addr，即其内存中的实际地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="k">constexpr</span> <span class="p">(</span><span class="n">IsGeneral</span> <span class="o">||</span> <span class="n">Mode</span> <span class="o">==</span> <span class="n">RelocMode</span><span class="o">::</span><span class="n">Typical</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//R_GENERIC_ABSOLUTE为数据引用的重定位类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">r_type</span> <span class="o">==</span> <span class="n">R_GENERIC_ABSOLUTE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">count_relocation_if</span><span class="o">&lt;</span><span class="n">IsGeneral</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kRelocAbsolute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sym_addr</span> <span class="o">+</span> <span class="n">get_addend_rel</span><span class="p">();</span>  <span class="c1">//get_addend_rel()返回重定位的数据的值，但其实际重定位的数据的值也为0。result = symaddr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">trace_reloc</span><span class="p">(</span><span class="s">&#34;RELO ABSOLUTE %16p &lt;- %16p %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">rel_target</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">sym_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">rel_target</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">//R_GENERIC_GLOB_DAT为数据引用的重定位类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r_type</span> <span class="o">==</span> <span class="n">R_GENERIC_GLOB_DAT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">count_relocation_if</span><span class="o">&lt;</span><span class="n">IsGeneral</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kRelocAbsolute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sym_addr</span> <span class="o">+</span> <span class="n">get_addend_norel</span><span class="p">();</span>  <span class="c1">//get_addend_norel()返回0，result = symaddr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">trace_reloc</span><span class="p">(</span><span class="s">&#34;RELO GLOB_DAT %16p &lt;- %16p %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">rel_target</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">sym_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">rel_target</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>           <span class="c1">//需要重定位的数据修正为symaddr，即其内存中的实际地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//R_GENERIC_RELATIVE为静态或全局变量引用的重定位类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r_type</span> <span class="o">==</span> <span class="n">R_GENERIC_RELATIVE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="n">count_relocation_if</span><span class="o">&lt;</span><span class="n">IsGeneral</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kRelocRelative</span><span class="p">);</span>                      <span class="c1">//get_addend_rel()返回重定位的数据的值 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">relocator</span><span class="p">.</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">load_bias</span> <span class="o">+</span> <span class="n">get_addend_rel</span><span class="p">();</span><span class="c1">//result = 基地址 + get_addend_rel()返回重定位的数据的值 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">trace_reloc</span><span class="p">(</span><span class="s">&#34;RELO RELATIVE %16p &lt;- %16p&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">rel_target</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">rel_target</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>            <span class="c1">//需要重定位的数据修正为：基地址 + get_addend_rel()返回重定位的数据的值，即指针指向的静态或全局变量实际的内存地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h4 id="2108-step-7-标记已链接并更新引用计数">
<a class="header-anchor" href="#2108-step-7-%e6%a0%87%e8%ae%b0%e5%b7%b2%e9%93%be%e6%8e%a5%e5%b9%b6%e6%9b%b4%e6%96%b0%e5%bc%95%e7%94%a8%e8%ae%a1%e6%95%b0"></a>
2.10.8. Step 7: 标记已链接并更新引用计数
</h4><p>标记所有库为已链接，并管理引用计数。将 <code>start_with</code> 和所有任务中的库标记为已链接，对于跨局部组引用的库，增加引用计数。确保库的状态一致，并防止意外卸载。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Step 7: Mark all load_tasks as linked and increment refcounts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// for references between load_groups (at this point it does not matter if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// referenced load_groups were loaded by previous dlopen or as part of this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// one on step 6)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">start_with</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">add_as_children</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_with</span><span class="o">-&gt;</span><span class="n">set_linked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="nl">task</span> <span class="p">:</span> <span class="n">load_tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_soinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="o">-&gt;</span><span class="n">set_linked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="nl">task</span> <span class="p">:</span> <span class="n">load_tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_soinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span><span class="o">*</span> <span class="n">needed_by</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">get_needed_by</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">needed_by</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">needed_by</span> <span class="o">!=</span> <span class="n">start_with</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">needed_by</span><span class="o">-&gt;</span><span class="n">get_local_group_root</span><span class="p">()</span> <span class="o">!=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">get_local_group_root</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">si</span><span class="o">-&gt;</span><span class="n">increment_ref_count</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h2 id="3-加壳技术">
<a class="header-anchor" href="#3-%e5%8a%a0%e5%a3%b3%e6%8a%80%e6%9c%af"></a>
3. 加壳技术
</h2><p>在病毒和版权保护领域，“壳”一直扮演着极为重要的角色。通过加壳可以对代码进行压缩和加密，同时再辅以虚拟化、代码混淆和反调试等手段，达到防止静态和动态分析。</p>
<p>在 Android 环境中，Native 层的加壳主要是针对动态链接库 SO，SO 加壳的示意图如下:
<img src="https://cdn.jsdelivr.net/gh/Asu1tty/blog_img@master/picSource/v2-b86226be6c03dbefee9ca83081b74c0d_1440w.png" alt="">
加壳工具、loader、被保护SO。</p>
<ul>
<li><strong>SO</strong>: 即被保护的目标 SO。</li>
<li><strong>loader</strong>: 自身也是一个 SO，系统加载时首先加载 loader，loader 首先还原出经过加密、压缩、变换的 SO，再将 SO 加载到内存，并完成链接过程，使 SO 可以正常被其他模块使用。</li>
<li><strong>加壳工具</strong>: 将被保护的 SO 加密、压缩、变换，并将结果作为数据与 loader 整合为 packed SO。
下面对 SO 加壳的关键技术进行简单介绍。</li>
</ul>
<h3 id="31-loader-执行时机">
<a class="header-anchor" href="#31-loader-%e6%89%a7%e8%a1%8c%e6%97%b6%e6%9c%ba"></a>
3.1. loader 执行时机
</h3><p>Linker 加载完 loader 后，loader 需要将被保护的 SO 加载起来，这就要求 loader 的代码需要被执行，而且要在 被保护 SO 被使用之前，前文介绍了 SO 的初始化函数便可以满足这个要求，同时在 Android 系统下还可以使用 JNI_ONLOAD 函数，因此 loader 的执行时机有两个选择:</p>
<ul>
<li>SO 的 init 或 initarray</li>
<li>jni_onload</li>
</ul>
<h3 id="32-loader-完成-so-的加载链接">
<a class="header-anchor" href="#32-loader-%e5%ae%8c%e6%88%90-so-%e7%9a%84%e5%8a%a0%e8%bd%bd%e9%93%be%e6%8e%a5"></a>
3.2. loader 完成 SO 的加载链接
</h3><p>loader 开始执行后，首先需要在内存中还原出 SO，SO 可以是经过加密、压缩、变换等手段，也可已单纯的以完全明文的数据存储，这与 SO 加壳的技术没有必要的关系，在此不进行讨论。</p>
<p>在内存中还原出 SO 后，loader 还需要执行装载和链接，这两个过程可以完全模仿 Linker 来实现，下面主要介绍一下相对 Linker，loader 执行这两个过程有哪些变化。</p>
<h4 id="321-装载">
<a class="header-anchor" href="#321-%e8%a3%85%e8%bd%bd"></a>
3.2.1. 装载
</h4><p>还原后的 SO 在内存中，所以装载时的主要变化就是从文件装载到从内存装载。<br>
Linker 在装载 PT_LAOD segment时，即<code>LoadSegments()</code>中，使用 SO 文件的描述符 fd：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// bionic/linker/linker_phdr.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="n">seg_addr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">seg_page_start</span><span class="p">),</span> <span class="n">seg_page_aligned_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">prot</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span></code></pre></div><p>按照 Linker 装载，PT_LAOD segment时，需要分为两步：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 1、改用匿名映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="n">seg_addr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">seg_page_start</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">seg_page_aligned_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">prot</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 2、将内存中的 segment 复制到映射的内存中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">seg_addr</span><span class="o">+</span><span class="n">seg_page_offset</span><span class="p">,</span> <span class="n">elf_data_buf</span> <span class="o">+</span> <span class="n">phdr</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="p">,</span> <span class="n">phdr</span><span class="o">-&gt;</span><span class="n">p_filesz</span><span class="p">);</span>
</span></span></code></pre></div><p>注意第2步复制 segment 时，目标地址需要加上 seg_page_offset，seg_page_offset 是 segment 相对与页面起始地址的偏移。<br>
其他的步骤基本按照 Linker 的实现即可，只需要将一些从文件读取修改为从内存读取，比如读 elfheader和program header时。</p>
<h4 id="322-分配-soinfo">
<a class="header-anchor" href="#322-%e5%88%86%e9%85%8d-soinfo"></a>
3.2.2. 分配 soinfo
</h4><p>soinfo 保存了 SO 装载链接和运行时需要的所有信息，为了维护相关的信息，loader 可以照搬 Linker 的 soinfo 结构，用于存储中间信息，装载链接结束后，还需要将 soinfo 的信息修复到 Linker 维护的soinfo，3.3节进行详细说明。</p>
<h4 id="323-链接">
<a class="header-anchor" href="#323-%e9%93%be%e6%8e%a5"></a>
3.2.3. 链接
</h4><p>链接过程完全是操作内存，不论是从文件装载还是内存装载，链接过程都是一样，完全模仿 Linker 即可。<br>
另外链接后记得顺便调用 SO 初始化函数( init 和 init_array )。</p>
<h3 id="33-soinfo-修复">
<a class="header-anchor" href="#33-soinfo-%e4%bf%ae%e5%a4%8d"></a>
3.3. soinfo 修复
</h3><p>SO 加壳的最关键技术点在于 soinfo 的修复，由于 Linker 加载的是 loader，而实际对外使用的是被保护的 SO，所以 Linker 维护的 soinfo 可以说是错误，loader 需要将自己维护的 soinfo 中的部分信息导出给 Linker 的soinfo。
修复过程如下：</p>
<ol>
<li>获取 Linker 维护的 soinfo，可以通过 dlopen 打开自己来获得：self_soinfo = dlopen(<em>self</em>)。</li>
<li>将 loader soinfo 中的信息导出到 self_soinfo，最简单粗暴的方式就是直接赋值，比如：self_soinfo.base = soinfo.base。需要导出的主要有以下几项：
<ul>
<li>SO地址范围：base、size、load_bias</li>
<li>符号信息:sym_tab、str_tab、</li>
<li>符号查找信息：nbucket、nchain、bucket、chain</li>
<li>异常处理：ARM_exidx、ARM_exidx_count</li>
</ul>
</li>
</ol>
<h2 id="4-参考资料">
<a class="header-anchor" href="#4-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99"></a>
4. 参考资料
</h2><p><strong>本文章源自以下文章内容，仅作学习和记录使用</strong></p>
<ul>
<li><a href="https://oacia.dev/android-load-so/">安卓so加载流程源码分析</a></li>
<li><a href="https://www.cnblogs.com/revercc/p/16299712.html">android源码分析之linker初始化</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/22652847">Android Linker 与 SO 加壳技术</a></li>
</ul>
</div>
    <footer class="article-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/android"
        rel="tag"
        >ANDROID</a
      >
    </li></ul>
</footer>
  </div><nav
    id="article-nav"
    data-aos="fade-up"
  ><div class="article-nav-link-wrap article-nav-link-left"><img
              data-src="https://d-sketon.top/img/_backwebp/bg1.webp"
              data-sizes="auto"
              alt="ELF结构及加载流程分析"
              class="lazyload"
            /><a href="/post/elfreader/"></a>
        <div class="article-nav-caption">前一篇</div>
        <h3 class="article-nav-title">ELF结构及加载流程分析</h3>
      </div><div class="article-nav-link-wrap article-nav-link-right"><img
              data-src="https://d-sketon.top/img/_backwebp/bg1.webp"
              data-sizes="auto"
              alt="浅析So加固的三种方式"
              class="lazyload"
            /><a href="/post/so-harden/"></a>
        <div class="article-nav-caption">后一篇</div>
        <h3 class="article-nav-title">浅析So加固的三种方式</h3>
      </div></nav></article></section>
        </div><footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info"><div>
      <span class="icon-copyright"></span>2020-2025<span class="footer-info-sep rotate"></span>
      Asu1tty
    </div><div>
        基于&nbsp;<a
          href="https://gohugo.io/"
          target="_blank"
          >Hugo</a
        >&nbsp; Theme.<a
          href="https://github.com/D-Sketon/hugo-theme-reimu"
          target="_blank"
          >Reimu</a
        >
      </div><div>
        <span class="icon-brush"
          >&nbsp;61.0k</span
        >
        &nbsp;|&nbsp;
        <span class="icon-coffee">&nbsp;02:08</span>
      </div><div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv"
          >总访问量&nbsp;<span
            id="busuanzi_value_site_pv"
          ></span
        ></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv"
          >总访客量&nbsp;<span
            id="busuanzi_value_site_uv"
          ></span
        ></span>
      </div></div>
</footer>
<div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div><div id="mask" class="hide"></div>
      </div><nav id="mobile-nav">
  <div class="sidebar-wrap"><div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">文章目录</h3>
  <div class="sidebar-toc-wrapper toc-div-class">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-java层调用">1. java层调用</a>
      <ul>
        <li><a href="#11-systemload">1.1. System.load()</a></li>
        <li><a href="#12-runtimegetruntimeload0">1.2. Runtime.getRuntime().load0()</a></li>
        <li><a href="#13-runtimejava-中的-nativeload">1.3. Runtime.java 中的 nativeLoad()</a></li>
      </ul>
    </li>
    <li><a href="#2-so层调用">2. so层调用</a>
      <ul>
        <li><a href="#21-runtimec-中的-nativeload">2.1. Runtime.c 中的 nativeLoad()</a></li>
        <li><a href="#22-jvm_nativeload">2.2. JVM_NativeLoad()</a></li>
        <li><a href="#23-loadnativelibrary">2.3. LoadNativeLibrary()</a></li>
        <li><a href="#24-androidopennativelibrary">2.4. android::OpenNativeLibrary()</a></li>
        <li><a href="#25-android_dlopen_ext">2.5. android_dlopen_ext()</a></li>
        <li><a href="#26-__loader_android_dlopen_ext">2.6. __loader_android_dlopen_ext()</a></li>
        <li><a href="#27-dlopen_ext">2.7. dlopen_ext</a></li>
        <li><a href="#28-do_dlopen">2.8. do_dlopen</a></li>
        <li><a href="#29-find_library">2.9. find_library</a></li>
        <li><a href="#210-find_libraries">2.10. find_libraries</a></li>
      </ul>
    </li>
    <li><a href="#3-加壳技术">3. 加壳技术</a>
      <ul>
        <li><a href="#31-loader-执行时机">3.1. loader 执行时机</a></li>
        <li><a href="#32-loader-完成-so-的加载链接">3.2. loader 完成 SO 的加载链接</a></li>
        <li><a href="#33-soinfo-修复">3.3. soinfo 修复</a></li>
      </ul>
    </li>
    <li><a href="#4-参考资料">4. 参考资料</a></li>
  </ul>
</nav>
  </div>
</div></div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img
    data-src="/avatar/avatar.webp"
    data-sizes="auto"
    alt="Asu1tty"
    class="lazyload"
  />
  <div class="sidebar-author-name">Asu1tty</div>
  <div class="sidebar-description">逆向小白学习中...</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>文章</div><div class="sidebar-state-number">14</div>
  </div>
  <a class="sidebar-state-category" href="/categories/" aria-label="sidebar-state-category-link">
    <div>分类</div>
    <div class="sidebar-state-number">
      5
    </div>
  </a>
  <a class="sidebar-state-tag" href="/tags/" aria-label="sidebar-state-tag-link">
    <div>标签</div>
    <div class="sidebar-state-number">14</div>
  </a>
</div>
<div class="sidebar-social"></div>
<div class="sidebar-menu"><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="首页"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">首页</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="归档"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">归档</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/about"
        aria-label="关于"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">关于</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/friend"
        aria-label="友链"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">友链</div>
    </div></div>
</div></div><div class="sidebar-btn-wrapper">
        <div class="sidebar-toc-btn current"></div>
        <div class="sidebar-common-btn"></div>
      </div></nav>
</div><script
    src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js"
    integrity="sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf&#43;e" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js"
    integrity="sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script><script src="/js/main.js" integrity="" crossorigin="anonymous" ></script><script src="/js/aos.js" integrity="" crossorigin="anonymous" ></script><script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", aosInit);
    } else {
      aosInit();
    }
  </script><script src="/js/pjax_main.js" integrity="" crossorigin="anonymous" data-pjax></script><script
    src="https://npm.webcache.cn/mouse-firework@0.1.1/dist/index.umd.js"
    integrity="sha384-8LyaidD9GPxQQgLJO/WRw/O2h3BoNq/ApI/ecpvM6RsrCz2qP2ppBXUKihP4V/2d" crossorigin="anonymous"></script><script>
  if (window.firework) {
    const options = JSON.parse("{\"excludeelements\":[\"a\",\"button\"],\"particles\":[{\"colors\":[\"var(--red-1)\",\"var(--red-2)\",\"var(--red-3)\",\"var(--red-4)\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"emit\"],\"number\":20,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.3,0.5],\"radius\":[16,32]}},{\"colors\":[\"var(--red-0)\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"diffuse\"],\"number\":1,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.2,0.5],\"lineWidth\":6,\"radius\":20}}]}");
    options.excludeElements = options.excludeelements;
    delete options.excludeelements;
    window.firework(options);
  }
</script>

<div id="lazy-script">
  <div><script data-pjax>
        window.REIMU_POST = {
          author: "Asu1tty",
          title: "Android so加载源码分析与加壳技术",
          url: "https:\/\/asu1tty.github.io\/post\/loading-so\/",
          description: "本次分析AOSP 的源码的安卓版本为 android-12.0.0_r34\n1. java层调用 So在java层的加载方式有两种\nSystem.loadLibrary(String libName) 或\nSystem.load(String path) 1.1. System.load() 这里我们以System.load作为分析入口\n",
          cover: "https:\/\/asu1tty.github.io\/images\/banner.webp",
        };
      </script><script src="/js/insert_highlight.js" integrity="" crossorigin="anonymous" data-pjax></script><script type="module" data-pjax>const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")}).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")}).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script></div>
</div><script
    src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js"
    asyncintegrity="sha384-0M75wtSkhjIInv4coYlaJU83&#43;OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id&#43;S" crossorigin="anonymous"></script><script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        for (let registration of registrations) {
          registration.unregister();
        }
      });
    }
  </script><script>
  const reimuCopyright = String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;
  console.log(String.raw`%c ${reimuCopyright}`, "color: #ff5252;");
  console.log(
    "%c Theme.Reimu" + " %c https://github.com/D-Sketon/hugo-theme-reimu ",
    "color: white; background: #ff5252; padding:5px 0;",
    "padding:4px;border:1px solid #ff5252;",
  );
</script></body>
</html>
